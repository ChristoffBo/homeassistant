#!/usr/bin/with-contenv bash

# Validate configuration
CONFIG="/data/options.json"
[[ ! -f "$CONFIG" ]] && { echo "ERROR: Missing config.json"; exit 1; }

# Parse configuration
export REPO_SOURCE=$(jq -r '.repo_source' "$CONFIG")
export ENABLE_GOTIFY=$(jq -r '.enable_gotify' "$CONFIG")
export GOTIFY_URL=$(jq -r '.gotify_url // empty' "$CONFIG")
export GOTIFY_TOKEN=$(jq -r '.gotify_token // empty' "$CONFIG")
export GITEA_API_URL=$(jq -r '.gitea_api_url // empty' "$CONFIG")
export GITEA_TOKEN=$(jq -r '.gitea_token // empty' "$CONFIG")
export REPO_PATH=$(jq -r '.repo_path' "$CONFIG")
export REPO_BRANCH=$(jq -r '.repo_branch' "$CONFIG")
export UPDATE_MODE=$(jq -r '.update_mode' "$CONFIG")
export DRY_RUN=$(jq -r '.dry_run // false' "$CONFIG")
export LOG_LEVEL=$(jq -r '.log_level' "$CONFIG")
export VALIDATE_SSL=$(jq -r '.validate_ssl // true' "$CONFIG")

# Validate required parameters
[[ ! "$REPO_SOURCE" =~ ^(github|gitea)$ ]] && {
  echo "ERROR: Invalid repo_source"; exit 1;
}

[[ "$REPO_SOURCE" == "gitea" ]] && {
  [[ -z "$GITEA_API_URL" ]] && { echo "ERROR: gitea_api_url required"; exit 1; }
  [[ -z "$GITEA_TOKEN" ]] && { echo "ERROR: gitea_token required"; exit 1; }
}

[[ "$ENABLE_GOTIFY" == "true" ]] && {
  [[ -z "$GOTIFY_URL" ]] && { echo "ERROR: gotify_url required"; exit 1; }
  [[ -z "$GOTIFY_TOKEN" ]] && { echo "ERROR: gotify_token required"; exit 1; }
}

# Initialize log file
touch /var/log/addons-updater.log
chmod 644 /var/log/addons-updater.log
