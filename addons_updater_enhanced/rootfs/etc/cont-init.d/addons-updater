#!/usr/bin/with-contenv bash

CONFIG="/data/options.json"

# Load config
export REPO_SOURCE=$(jq -r '.repo_source' "$CONFIG")
export ENABLE_NOTIFICATIONS=$(jq -r '.enable_notifications' "$CONFIG")
export GOTIFY_URL=$(jq -r '.gotify_url // empty' "$CONFIG")
export GOTIFY_TOKEN=$(jq -r '.gotify_token // empty' "$CONFIG")
export GITEA_API_URL=$(jq -r '.gitea_api_url // empty' "$CONFIG")
export GITEA_TOKEN=$(jq -r '.gitea_token // empty' "$CONFIG")
export REPO_PATH=$(jq -r '.repo_path' "$CONFIG")
export REPO_BRANCH=$(jq -r '.repo_branch' "$CONFIG")
export UPDATE_MODE=$(jq -r '.update_mode' "$CONFIG")
export DRY_RUN=$(jq -r '.dry_run' "$CONFIG")
export LOG_LEVEL=$(jq -r '.log_level' "$CONFIG")
export VALIDATE_SSL=$(jq -r '.validate_ssl' "$CONFIG")
export TIMEOUT=$(jq -r '.timeout' "$CONFIG")

# Validate repo source
case "$REPO_SOURCE" in
  github|gitea) ;;
  *)
    echo "ERROR: Invalid repo_source '$REPO_SOURCE'" >&2
    exit 1
    ;;
esac

# Validate Gitea if selected
if [ "$REPO_SOURCE" = "gitea" ]; then
  if [ -z "$GITEA_API_URL" ] || [ -z "$GITEA_TOKEN" ]; then
    echo "ERROR: Gitea requires api_url and token" >&2
    exit 1
  fi
fi

# Only validate Gotify if enabled
if [ "$ENABLE_NOTIFICATIONS" = "true" ]; then
  if [ -z "$GOTIFY_URL" ] || [ -z "$GOTIFY_TOKEN" ]; then
    echo "WARNING: Notifications enabled but missing Gotify config" >&2
  fi
fi

# Initialize log file
touch /var/log/addons-updater.log
chmod 644 /var/log/addons-updater.log
