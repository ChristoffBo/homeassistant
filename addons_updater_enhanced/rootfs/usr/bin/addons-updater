#!/bin/bash
set -eo pipefail

CONFIG="/data/options.json"
REPO_SOURCE=$(jq -r '.repo_source' "$CONFIG")

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1: $2"
}

cd "$(jq -r '.repo_path' "$CONFIG")" || {
    log "ERROR" "Failed to access repo path"
    exit 1
}

for path in $(jq -r '.addon_paths[]' "$CONFIG"); do
    for addon in "$path"/*; do
        [ -f "$addon/config.json" ] || continue
        current=$(jq -r '.version' "$addon/config.json")
        upstream=$(jq -r '.upstream_repo' "$addon/config.json")
        
        if [ "$REPO_SOURCE" = "gitea" ]; then
            latest=$(curl -sSf "${GITEA_API_URL}/repos/${upstream}/releases/latest" | jq -r '.tag_name')
        else
            latest=$(curl -sSf "https://api.github.com/repos/${upstream}/releases/latest" | jq -r '.tag_name')
        fi
        
        [ "$current" != "$latest" ] && {
            log "INFO" "Updating ${addon} from ${current} to ${latest}"
            jq --arg ver "$latest" '.version = $ver' "$addon/config.json" > "${addon}/config.json.tmp"
            mv "${addon}/config.json.tmp" "$addon/config.json"
        }
    done
done

log "INFO" "Update process completed"
exit 0
