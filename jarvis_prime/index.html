<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jarvis Prime â€” Inbox</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
    <style>
      :root {
        --jarvis-accent: #00b3ff;
        --jarvis-bg: #0b0f14;
      }
      body { background: var(--jarvis-bg); }
      header h1 { letter-spacing: .02em; }
      .toolbar { display: grid; grid-template-columns: 1fr 150px auto auto; gap: .75rem; align-items: center; }
      .shell { display: grid; grid-template-columns: 380px 1fr; gap: 1rem; height: calc(100vh - 200px); }
      .list { border-radius: 14px; background: rgba(255,255,255,.03); overflow: hidden; display: flex; flex-direction: column; }
      .items { overflow: auto; }
      .item { padding: .85rem 1rem; border-bottom: 1px solid rgba(255,255,255,.06); cursor: pointer; }
      .item:hover { background: rgba(255,255,255,.06); }
      .item.active { background: rgba(0,179,255,.14); border-left: 3px solid var(--jarvis-accent); }
      .item .meta { font-size: .8rem; opacity: .7; display: flex; gap: .5rem; }
      .preview { border-radius: 14px; background: rgba(255,255,255,.03); padding: 1rem; overflow: auto; }
      .muted { opacity: .7; }
      .pill { padding: .15rem .5rem; border-radius: 999px; font-size: .75rem; }
      .ok { background: #16a34a; color: white; }
      .warn { background: #e11d48; color: white; }
      pre { white-space: pre-wrap; }
      .actions { display: flex; gap: .5rem; }
    </style>
  </head>
  <body>
    <main class="container">
      <header style="margin: 1.2rem 0 0.6rem;">
        <h1>ðŸ“¥ Jarvis Prime â€” Inbox</h1>
        <p class="muted">Unified inbox with real-time preview, dark mode, purge & search.</p>
      </header>

      <section class="toolbar">
        <input id="q" name="q" type="search" placeholder="Search title, body, sourceâ€¦" />
        <select id="limit">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
        <button id="btnSearch">Search</button>
        <button id="btnRefresh" class="secondary outline">Refresh</button>
      </section>

      <section style="margin-top: .5rem;">
        <div class="shell">
          <div class="list">
            <div style="padding: .75rem 1rem; display:flex; justify-content:space-between; align-items:center;">
              <strong>Messages</strong>
              <div class="actions">
                <label class="muted">Retention (days)</label>
                <input id="retentionDays" type="number" min="1" value="30" style="max-width: 6rem;">
                <button id="btnSaveRetention" class="outline">Save</button>
                <button id="btnPurgeNow" class="contrast">Purge</button>
              </div>
            </div>
            <div id="items" class="items"></div>
          </div>
          <div class="preview" id="preview">
            <h3 class="muted">Select a message</h3>
          </div>
        </div>
      </section>
    </main>

    <script>
      const API_BASE = location.pathname.replace(/\/ui\/?$/, "").replace(/\/ui\/.*$/, "");

      const el = (s) => document.querySelector(s);
      const itemsEl = el("#items");
      const previewEl = el("#preview");

      function fmtTs(ts){ try{ return new Date(ts*1000).toLocaleString(); }catch{ return ts; } }
      function pill(ok,fail){
        const parts=[];
        if(ok) parts.push(`<span class="pill ok">OK ${ok}</span>`);
        if(fail) parts.push(`<span class="pill warn">Fail ${fail}</span>`);
        return parts.join(" ");
      }
      function okFail(delivered){
        try{
          const d = (typeof delivered==="string")?JSON.parse(delivered): (delivered||{});
          let ok=0, fail=0;
          for(const k of Object.keys(d)){
            const v=d[k]||{}; const code=Number(v.status||v.code||v.status_code||v.http||0);
            if(code>=200 && code<400) ok++; else fail++;
          }
          return [ok,fail];
        }catch{return [0,0];}
      }

      function renderItem(it, active=false){
        const [ok,fail] = okFail(it.delivered);
        const div = document.createElement("div");
        div.className = "item" + (active?" active":"");
        div.innerHTML = \`
          <div style="display:flex; justify-content:space-between; gap:1rem;">
            <div>
              <div><strong>\${it.title || "(no title)"} </strong></div>
              <div class="meta"><span>\${it.source}</span><span>â€¢</span><span>\${fmtTs(it.ts)}</span></div>
            </div>
            <div>\${pill(ok,fail)}</div>
          </div>\`;
        div.addEventListener("click", () => showPreview(it, div));
        return div;
      }

      async function loadSettings(){
        try{ const r=await fetch(\`\${API_BASE}/api/inbox/settings\`);
          const j=await r.json(); el("#retentionDays").value = j.retention_days ?? 30;
        }catch(e){ console.warn(e); }
      }

      async function saveRetention(){
        const days = Number(el("#retentionDays").value || 30);
        const r = await fetch(\`\${API_BASE}/api/inbox/settings\`, { method:"PUT", headers:{ "Content-Type":"application/json"}, body: JSON.stringify({retention_days:days}) });
        if(r.ok) alert("Retention saved."); else alert("Failed to save retention.");
      }

      async function purgeNow(){
        const days = Number(el("#retentionDays").value || 30);
        if(!confirm(\`Purge messages older than \${days} days?\`)) return;
        const r = await fetch(\`\${API_BASE}/api/messages/purge\`, { method:"POST", headers:{ "Content-Type":"application/json"}, body: JSON.stringify({days}) });
        if(r.ok){ await loadMessages(); } else { alert("Purge failed."); }
      }

      function showPreview(it, div){
        document.querySelectorAll(".item").forEach(x => x.classList.remove("active"));
        if(div) div.classList.add("active");
        const [ok,fail] = okFail(it.delivered);
        previewEl.innerHTML = \`
          <article>
            <header><h3>\${it.title || "(no title)"} </h3></header>
            <p class="muted">\${it.source} â€¢ \${fmtTs(it.ts)} â€¢ \${pill(ok,fail)}</p>
            <pre>\${(it.body || "").replace(/[<>]/g, s => ({"<":"&lt;",">":"&gt;"}[s]))}</pre>
            <footer style="display:flex; gap:.5rem;">
              <button class="secondary outline" onclick="doDelete(\${it.id})">Delete</button>
              <button class="outline" onclick="navigator.clipboard.writeText(it.body||'');">Copy body</button>
            </footer>
          </article>\`;
      }

      async function doDelete(id){
        if(!confirm("Delete this message?")) return;
        const r = await fetch(\`\${API_BASE}/api/messages/\${id}\`, { method: "DELETE" });
        if(r.ok){ await loadMessages(); }
      }

      async function loadMessages(){
        const q = encodeURIComponent(el("#q").value || "");
        const limit = encodeURIComponent(el("#limit").value || "50");
        itemsEl.innerHTML = '<div class="item"><span class="muted">Loadingâ€¦</span></div>';
        const r = await fetch(\`\${API_BASE}/api/messages?limit=\${limit}\${q?`&q=\${q}`:""}\`);
        const j = await r.json();
        itemsEl.innerHTML = "";
        (j.items || []).forEach((it, idx) => itemsEl.appendChild(renderItem(it, idx===0)));
        if((j.items || []).length){
          showPreview(j.items[0]);
        } else {
          previewEl.innerHTML = '<h3 class="muted">No messages</h3>';
          itemsEl.innerHTML = '<div class="item"><span class="muted">No messages.</span></div>';
        }
      }

      el("#btnSearch").addEventListener("click", loadMessages);
      el("#btnRefresh").addEventListener("click", loadMessages);
      el("#btnSaveRetention").addEventListener("click", saveRetention);
      el("#btnPurgeNow").addEventListener("click", purgeNow);

      (async function boot(){ await loadSettings(); await loadMessages(); })();
    </script>
  </body>
</html>
