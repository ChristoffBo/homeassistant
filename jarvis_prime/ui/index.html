<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Jarvis Prime Control System</title>
  
  <script>window.JARVIS_API_BASE = window.JARVIS_API_BASE || null;</script>
  
  <script>
    (function () {
      var p = location.pathname;
      if (p.endsWith('/index.html')) p = p.slice(0, -'index.html'.length);
      var dir = p.endsWith('/') ? p : p.replace(/[^\/]*$/, '');
      if (!dir.endsWith('/') && dir !== '') dir += '/';
      document.write('<base href="' + dir + '">');
    })();
  </script>

  <link rel="stylesheet" href="style.css?v=5.0" />
  
  <!-- Favicon / Browser tab icons -->
  <link rel="icon" href="/icon/icon-16x16.png" sizes="16x16" type="image/png">
  <link rel="icon" href="/icon/icon-32x32.png" sizes="32x32" type="image/png">
  <link rel="apple-touch-icon" href="/icon/icon-192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/icon/icon-512x512.png" sizes="512x512">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Jarvis">
  <meta name="msapplication-TileColor" content="#0f1419">
</head>

<body>
  <!-- PREMIUM GLASSMORPHIC NAVIGATION -->
  <nav class="glass-nav">
    <div class="nav-container">
      <div class="nav-brand">
        <div class="brand-icon">
          <img src="/icon/icon-512x512.png" alt="Jarvis" />
        </div>
        <div class="brand-text">
          <h1>Jarvis Prime</h1>
          <p>Control System</p>
        </div>
      </div>
      
      <ul class="nav-tabs">
        <li class="nav-tab active" data-tab="dashboard">Dashboard</li>
        <li class="nav-tab" data-tab="inbox">Inbox</li>
        <li class="nav-tab" data-tab="orchestrator">Orchestrator</li>
        <li class="nav-tab" data-tab="sentinel">Sentinel</li>
        <li class="nav-tab" data-tab="analytics">Analytics</li>
        <li class="nav-tab" data-tab="backup">Backup</li>
        <li class="nav-tab" data-tab="atlas">Atlas</li>
        <li class="nav-tab" data-tab="settings">Settings</li>
      </ul>
      
      <div class="system-status">
        <div class="status-indicator">
          <div class="status-dot" id="connection-status"></div>
          <span id="system-status-text">Connected</span>
        </div>
        <button id="theme-toggle" class="btn" style="margin-left: 12px; padding: 8px 16px;" title="Toggle Dark Mode">
          <span id="theme-icon">ðŸŒ™</span>
        </button>
      </div>
    </div>
  </nav>

  <main class="main-container" id="main-container">
    <!-- Tab panels will be loaded dynamically here -->
  </main>

  <!-- Modals container -->
  <div id="modals-container"></div>

  <!-- Toast notifications -->
  <div id="toast"></div>

  <!-- Auth Overlay -->
  <div id="auth-overlay"></div>

  <!-- Module Loader Script -->
  <script>
  // Component loader - loads HTML modules dynamically
  window.ModuleLoader = {
    cache: {},
    
    async loadComponent(path) {
      if (this.cache[path]) return this.cache[path];
      
      try {
        const response = await fetch(path + '?v=' + Date.now());
        if (!response.ok) throw new Error(`Failed to load ${path}`);
        const html = await response.text();
        this.cache[path] = html;
        return html;
      } catch (err) {
        console.error(`[ModuleLoader] Error loading ${path}:`, err);
        return `<div class="error">Failed to load component: ${path}</div>`;
      }
    },
    
    async loadTab(tabName) {
      const html = await this.loadComponent(`components/tabs/${tabName}.html`);
      return html;
    },
    
    async loadModal(modalName) {
      const html = await this.loadComponent(`components/modals/${modalName}.html`);
      return html;
    },
    
    async loadAllModals() {
      const modalNames = [
        'server-modal',
        'edit-server-modal',
        'schedule-modal',
        'history-modal',
        'job-output-modal',
        'analytics-service-modal',
        'sentinel-modals',
        'backup-modals'
      ];
      
      const container = document.getElementById('modals-container');
      for (const modalName of modalNames) {
        const html = await this.loadModal(modalName);
        container.insertAdjacentHTML('beforeend', html);
      }
    },
    
    clearCache() {
      this.cache = {};
    }
  };

  // Initialize app when DOM is ready
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('[Jarvis] Initializing modular UI...');
    
    // Load all modals first (they're shared across tabs)
    await window.ModuleLoader.loadAllModals();
    
    // Load initial dashboard tab
    const mainContainer = document.getElementById('main-container');
    const dashboardHTML = await window.ModuleLoader.loadTab('dashboard');
    mainContainer.innerHTML = dashboardHTML;
    
    console.log('[Jarvis] Modular UI loaded successfully');
  });
  </script>

  <!-- Auth check -->
  <script>
  (async () => {
    try {
      const res = await fetch("/api/auth/status");
      if (!res.ok) throw new Error("Auth API not reachable");
      const { status } = await res.json();
      if (status === "setup" || status === "login") {
        const script = document.createElement("script");
        script.src = "auth.js?v=" + Date.now();
        document.head.appendChild(script);
      }
    } catch (e) {
      console.error("[auth preload]", e);
    }
  })();
  </script>

  <!-- Core application scripts -->
  <script src="app.js?v=5.0"></script>
  <script src="d3.v7.min.js"></script>
  <script src="orchestrator.js?v=1.3"></script>
  <script src="sentinel.js?v=1.0"></script>
  <script src="analytics.js?v=1.0"></script>
  <script src="settings.js?v=1.0"></script>
  <script src="atlas.js?v=1.0"></script>
  <script src="backup.js?v=1.0"></script>
</body>
</html>
