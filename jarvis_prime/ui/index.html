<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Jarvis Prime</title>

  <!-- Optional: override API base if UI is hosted elsewhere
       Example: window.JARVIS_API_BASE='http://10.0.0.100:2581/';
  -->
  <script>
    window.JARVIS_API_BASE = window.JARVIS_API_BASE || null;
  </script>

  <!-- Make relative URLs work for both Ingress and direct host -->
  <script>
    (function () {
      var p = location.pathname;
      if (p.endsWith('/index.html')) p = p.slice(0, -'index.html'.length);
      var dir = p.endsWith('/') ? p : p.replace(/[^\/]*$/, '');
      if (!dir.endsWith('/')) dir += '/';
      document.write('<base href="' + dir + '">');
    })();
  </script>

  <link rel="stylesheet" href="style.css?v=1.6" />
</head>
<body>
  <header class="topnav">
    <div class="brand">Jarvis Prime</div>
    <nav>
      <button class="tablink active" data-tab="inbox">Inbox</button>
      <button class="tablink" data-tab="jarvis-settings">Jarvis Settings</button>
      <button class="tablink" data-tab="aegis-settings">AegisOps â€“ Settings</button>
      <button class="tablink" data-tab="aegis-schedules">AegisOps â€“ Schedules</button>
      <button class="tablink" data-tab="aegis-runs">AegisOps â€“ Runs & Logs</button>
    </nav>
  </header>

  <main>
    <!-- Inbox -->
    <section id="inbox" class="tab active">
      <h2>Inbox</h2>
      <div class="stats">
        <div class="stat blue">Messages Today: <span id="msg-today">-</span></div>
        <div class="stat green">Archived: <span id="msg-arch">-</span></div>
        <div class="stat red">Errors: <span id="msg-err">-</span></div>
      </div>

      <div class="inbox-wrap">
        <div class="inbox-left">
          <table class="msg-table">
            <thead>
              <tr>
                <th>Time</th><th>Source</th><th>Title</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="msg-body"><tr><td colspan="4">Loadingâ€¦</td></tr></tbody>
          </table>
          <div class="inbox-actions">
            <label class="lbl">
              <input type="checkbox" id="keep-arch" /> Keep archived
            </label>
            <button id="del-all" class="btn danger">ðŸ—‘ Delete All</button>
          </div>
        </div>

        <aside class="inbox-preview">
          <div class="preview-head">
            <div class="ph-left">
              <div class="ph-title" id="pv-title">No message selected</div>
              <div class="ph-meta" id="pv-meta">â€“</div>
            </div>
            <label class="lbl ph-follow">
              <input type="checkbox" id="pv-follow" checked /> Auto-preview new
            </label>
          </div>
          <div class="preview-body" id="pv-body">
            <p class="muted">Click a message to see its contents here. When Auto-preview is on, the newest message will show as it arrives.</p>
          </div>
        </aside>
      </div>
    </section>

    <!-- Jarvis Settings (curated: personas, intakes, retention/quiet, LLM, Enviro) -->
    <section id="jarvis-settings" class="tab">
      <h2>Jarvis Settings</h2>

      <fieldset>
        <legend>Personas</legend>
        <label class="lbl"><input type="checkbox" id="p-dude"> Dude</label>
        <label class="lbl"><input type="checkbox" id="p-chick"> Chick</label>
        <label class="lbl"><input type="checkbox" id="p-nerd"> Nerd</label>
        <label class="lbl"><input type="checkbox" id="p-rager"> Rager</label>
        <div><button id="save-personas" class="btn">Save Personas</button></div>
      </fieldset>

      <fieldset>
        <legend>Intakes (Email / Gotify / ntfy)</legend>
        <div class="grid3">
          <div>
            <h3>Email</h3>
            <input id="smtp-host" placeholder="smtp.gmail.com" />
            <input id="smtp-port" placeholder="587" />
            <input id="smtp-user" placeholder="user" />
            <input id="smtp-pass" type="password" placeholder="password" />
            <input id="smtp-from" placeholder="From name" />
            <div class="grid2">
              <button id="test-email" class="btn">Test Email</button>
            </div>
          </div>
          <div>
            <h3>Gotify</h3>
            <input id="gotify-url" placeholder="http://10.0.0.99:8091" />
            <input id="gotify-token" placeholder="token" />
            <button id="test-gotify" class="btn">Test Gotify</button>
          </div>
          <div>
            <h3>ntfy</h3>
            <input id="ntfy-url" placeholder="http://10.0.0.99:8080" />
            <input id="ntfy-topic" placeholder="topic" />
            <button id="test-ntfy" class="btn">Test ntfy</button>
          </div>
        </div>
        <button id="save-channels" class="btn primary">Save Intakes</button>
      </fieldset>

      <fieldset>
        <legend>Inbox Retention & Purge</legend>
        <div class="grid3">
          <label>Retention days <input id="retention" type="number" /></label>
          <div>
            <label>Purge older than <input id="purge-days" type="number" /></label>
            <button id="purge" class="btn danger">Run Purge</button>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Quiet Hours</legend>
        <div class="grid3">
          <label>Timezone <input id="qh-tz" placeholder="Africa/Johannesburg" /></label>
          <label>Quiet start <input id="qh-start" placeholder="22:00" /></label>
          <label>Quiet end <input id="qh-end" placeholder="06:00" /></label>
        </div>
        <label class="lbl"><input id="qh-allow-critical" type="checkbox" /> Allow Critical Outside</label>
        <button id="save-quiet" class="btn">Save Quiet Hours</button>
      </fieldset>

      <fieldset>
        <legend>LLM</legend>
        <div class="grid3">
          <label>Model <input id="llm-model" placeholder="model name" /></label>
          <label>Context Tokens <input id="llm-ctx" type="number" /></label>
          <label>Timeout (s) <input id="llm-timeout" type="number" /></label>
        </div>
        <button id="save-llm" class="btn">Save LLM</button>
      </fieldset>

      <fieldset>
        <legend>EnviroGuard</legend>
        <p>Status: <span id="env-status">-</span></p>
        <div class="grid3">
          <label>Hot Â°C <input id="env-hot" type="number" /></label>
          <label>Cold Â°C <input id="env-cold" type="number" /></label>
          <label>Hysteresis Â°C <input id="env-hyst" type="number" /></label>
        </div>
        <button id="save-env" class="btn">Save EnviroGuard</button>
      </fieldset>
    </section>

    <!-- AegisOps â€“ Settings -->
    <section id="aegis-settings" class="tab">
      <h2>AegisOps â€” Settings</h2>
      <p class="muted">Manage inventory and playbooks. (Backed by files in <code>/share/jarvis_prime/aegisops/</code>.)</p>

      <fieldset>
        <legend>Inventory</legend>
        <p class="muted">Hosts / groups from <code>inventory.ini</code>. (UI editing to be wired.)</p>
        <textarea id="aegis-inventory-view" placeholder="[all]
localhost ansible_host=127.0.0.1 ansible_user=root"></textarea>
        <button id="aegis-inventory-save" class="btn">Save Inventory</button>
      </fieldset>

      <fieldset>
        <legend>Playbooks</legend>
        <p class="muted">Available playbooks under <code>playbooks/</code>. (Listing/runner to be wired.)</p>
        <input id="aegis-playbook-path" placeholder="playbooks/check_services.yml" />
        <button id="aegis-playbook-run" class="btn">Run Once (Manual)</button>
      </fieldset>
    </section>

    <!-- AegisOps â€“ Schedules -->
    <section id="aegis-schedules" class="tab">
      <h2>AegisOps â€” Schedules</h2>
      <p class="muted">Create/edit scheduled jobs (backed by <code>schedules.json</code>).</p>

      <fieldset>
        <legend>New Schedule</legend>
        <div class="grid3">
          <label>Id <input id="ag-sch-id" placeholder="uptime-5m" /></label>
          <label>Playbook <input id="ag-sch-playbook" placeholder="check_services.yml" /></label>
          <label>Servers <input id="ag-sch-servers" placeholder="all or host1,host2" /></label>
          <label>Every <select id="ag-sch-every">
            <option>5m</option><option>15m</option><option>1h</option><option>6h</option><option>24h</option>
          </select></label>
          <label>Forks <input id="ag-sch-forks" type="number" value="1"/></label>
        </div>
        <div class="grid3">
          <label class="lbl"><input id="ag-notify-success" type="checkbox" /> Notify on success</label>
          <label class="lbl"><input id="ag-notify-fail" type="checkbox" checked/> Notify on fail</label>
          <label class="lbl"><input id="ag-notify-change" type="checkbox" checked/> Only on state change</label>
          <label>Cooldown (min) <input id="ag-notify-cooldown" type="number" value="30"/></label>
          <label>Quiet Hours <input id="ag-notify-quiet" placeholder="22:00-06:00"/></label>
          <label>Target Key <input id="ag-notify-key" placeholder="uptime"/></label>
        </div>
        <button id="ag-add" class="btn primary">Add / Update</button>
      </fieldset>

      <fieldset>
        <legend>Existing Schedules</legend>
        <table class="msg-table">
          <thead><tr><th>ID</th><th>Playbook</th><th>Servers</th><th>Every</th><th>Actions</th></tr></thead>
          <tbody id="ag-table"><tr><td colspan="5">No data (wire API)</td></tr></tbody>
        </table>
      </fieldset>
    </section>

    <!-- AegisOps â€“ Runs & Logs -->
    <section id="aegis-runs" class="tab">
      <h2>AegisOps â€” Runs & Logs</h2>
      <p class="muted">Recent executions from the AegisOps SQLite DB.</p>
      <table class="msg-table">
        <thead><tr><th>Time</th><th>Playbook</th><th>Status</th><th>OK</th><th>Changed</th><th>Failed</th><th>Unreach</th></tr></thead>
        <tbody id="ag-runs"><tr><td colspan="7">No data (wire API)</td></tr></tbody>
      </table>
      <button id="ag-refresh" class="btn">Refresh</button>
    </section>
  </main>

  <div id="toast"></div>
  <script src="app.js?v=1.6"></script>
</body>
</html>
