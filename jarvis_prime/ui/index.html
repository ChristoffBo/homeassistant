<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Jarvis Prime Control System</title>
  
  <script>window.JARVIS_API_BASE = window.JARVIS_API_BASE || null;</script>
  
  <script>
    (function () {
      var p = location.pathname;
      if (p.endsWith('/index.html')) p = p.slice(0, -'index.html'.length);
      var dir = p.endsWith('/') ? p : p.replace(/[^\/]*$/, '');
      if (!dir.endsWith('/') && dir !== '') dir += '/';
      document.write('<base href="' + dir + '">');
    })();
  </script>

  <link rel="stylesheet" href="style.css?v=5.0" />
  
  <!-- Favicon / Browser tab icons -->
  <link rel="icon" href="/icon/icon-16x16.png" sizes="16x16" type="image/png">
  <link rel="icon" href="/icon/icon-32x32.png" sizes="32x32" type="image/png">
  <link rel="apple-touch-icon" href="/icon/icon-192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/icon/icon-512x512.png" sizes="512x512">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Jarvis">
  <meta name="msapplication-TileColor" content="#0f1419">
</head>

<body>
  <!-- PREMIUM GLASSMORPHIC NAVIGATION -->
  <nav class="glass-nav">
    <div class="nav-container">
      <div class="nav-brand">
        <div class="brand-icon">
          <img src="/icon/icon-512x512.png" alt="Jarvis" />
        </div>
        <div class="brand-text">
          <h1>Jarvis Prime</h1>
          <p>Control System</p>
        </div>
      </div>
      
      <ul class="nav-tabs">
        <li class="nav-tab active" data-tab="dashboard">Dashboard</li>
        <li class="nav-tab" data-tab="inbox">Inbox</li>
        <li class="nav-tab" data-tab="orchestrator">Orchestrator</li>
        <li class="nav-tab" data-tab="analytics">Analytics</li>
        <li class="nav-tab" data-tab="settings">Settings</li>
      </ul>
      
      <div class="system-status">
        <div class="status-indicator">
          <div class="status-dot" id="connection-status"></div>
          <span id="system-status-text">Connected</span>
        </div>
        <button id="theme-toggle" class="btn" style="margin-left: 12px; padding: 8px 16px;" title="Toggle Dark Mode">
          <span id="theme-icon">🌙</span>
        </button>
      </div>
    </div>
  </nav>

  <main class="main-container">
    <!-- DASHBOARD TAB -->
    <section id="dashboard" class="tab-panel active">
      <div class="page-header">
        <h2 class="page-title">System Overview</h2>
        <p class="page-subtitle">Real-time metrics from all modules</p>
      </div>
      
      <div class="metrics-grid-dashboard">
        <div class="metric-card" onclick="switchTab('inbox')">
          <div class="metric-header">
            <div>
              <div class="metric-value" id="dash-inbox-total">0</div>
              <div class="metric-label">Total Messages</div>
            </div>
            <div class="metric-icon" style="background: rgba(16, 185, 129, 0.12); color: #10b981;">
              <svg class="icon icon-lg" fill="none" viewBox="0 0 24 24">
                <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
        </div>
        
        <div class="metric-card" onclick="switchTab('inbox')">
          <div class="metric-header">
            <div>
              <div class="metric-value" id="dash-inbox-today">0</div>
              <div class="metric-label">Messages Today</div>
            </div>
            <div class="metric-icon" style="background: rgba(14, 165, 233, 0.12); color: #0ea5e9;">
              <svg class="icon icon-lg" fill="none" viewBox="0 0 24 24">
                <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
        </div>
        
        <div class="metric-card" onclick="switchTab('inbox')">
          <div class="metric-header">
            <div>
              <div class="metric-value" id="dash-inbox-errors">0</div>
              <div class="metric-label">Error Messages</div>
            </div>
            <div class="metric-icon" style="background: rgba(239, 68, 68, 0.12); color: #ef4444;">
              <svg class="icon icon-lg" fill="none" viewBox="0 0 24 24">
                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
        </div>
        
        <div class="metric-card" onclick="switchTab('inbox')">
          <div class="metric-header">
            <div>
              <div class="metric-value" id="dash-chat-status" style="font-size: 24px;">Ready</div>
              <div class="metric-label">Chat Status</div>
            </div>
            <div class="metric-icon" style="background: rgba(14, 165, 233, 0.12); color: #0ea5e9;">
              <svg class="icon icon-lg" fill="none" viewBox="0 0 24 24">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2v10z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
          <div class="metric-change">
            <span style="color: var(--text-muted);">AI assistant active</span>
          </div>
        </div>
        
        <div class="metric-card" onclick="switchTab('inbox')">
          <div class="metric-header">
            <div>
              <div class="metric-value" id="dash-commands">0</div>
              <div class="metric-label">Commands</div>
            </div>
            <div class="metric-icon" style="background: rgba(56, 189, 248, 0.12); color: #38bdf8;">
              <svg class="icon icon-lg" fill="none" viewBox="0 0 24 24">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
          <div class="metric-change">
            <span style="color: var(--text-muted);" id="dash-last-command">No commands sent</span>
          </div>
        </div>
        
        <div class="metric-card" onclick="switchTab('orchestrator')">
          <div class="metric-header">
            <div>
              <div class="metric-value" id="dash-playbooks">0</div>
              <div class="metric-label">Active Playbooks</div>
            </div>
            <div class="metric-icon" style="background: rgba(245, 158, 11, 0.12); color: #f59e0b;">
              <svg class="icon icon-lg" fill="none" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                <path d="M12 1v6m0 6v6m8.66-15.66l-4.24 4.24m-8.48 8.48l-4.24 4.24M23 12h-6M7 12H1m16.66 8.66l-4.24-4.24m-8.48-8.48L.34 3.34" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
          <div class="metric-change">
            <span style="color: var(--text-muted);" id="dash-schedules">0 scheduled</span>
          </div>
        </div>
        
        <div class="metric-card" onclick="switchTab('analytics')">
          <div class="metric-header">
            <div>
              <div class="metric-value" id="dash-health">0%</div>
              <div class="metric-label">System Health</div>
            </div>
            <div class="metric-icon" style="background: rgba(16, 185, 129, 0.12); color: #10b981;">
              <svg class="icon icon-lg" fill="none" viewBox="0 0 24 24">
                <path d="M3 3v18h18M7 16l4-4 4 4 6-6" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
          <div class="metric-change positive">
            <span>All services</span>
            <span class="status-badge status-online">
              <span class="status-dot"></span>
              Online
            </span>
          </div>
        </div>
        
        <div class="metric-card" onclick="switchTab('orchestrator')">
          <div class="metric-header">
            <div>
              <div class="metric-value" style="font-size: 32px;">
                <span id="dash-orch-success" style="color: #10b981;">0</span> / 
                <span id="dash-orch-errors" style="color: #ef4444;">0</span>
              </div>
              <div class="metric-label">Orchestration Jobs</div>
            </div>
            <div class="metric-icon" style="background: rgba(139, 92, 246, 0.12); color: #8b5cf6;">
              <svg class="icon icon-lg" fill="none" viewBox="0 0 24 24">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
          </div>
          <div class="metric-change">
            <span style="color: #10b981;">Success</span>
            <span style="color: var(--text-muted);">/</span>
            <span style="color: #ef4444;">Failed</span>
          </div>
        </div>
      </div>
      
      <div class="glass-card" style="margin-top: 32px;">
        <div class="card-header">
          <h3 class="card-title">Recent Activity</h3>
          <span class="status-badge status-online">
            <span class="status-dot"></span>
            Live
          </span>
        </div>
        <div class="card-body">
          <ul class="activity-list" id="dash-activity">
            <li class="activity-item">
              <div class="activity-icon" style="background: rgba(16, 185, 129, 0.12); color: #10b981;">
                <svg class="icon" fill="none" viewBox="0 0 24 24">
                  <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke="currentColor" stroke-width="2"/>
                </svg>
              </div>
              <div class="activity-content">
                <div class="activity-title">System initialized</div>
                <div class="activity-time">Just now</div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- INBOX TAB -->
    <section id="inbox" class="tab-panel">
      <div class="panel-header">
        <div class="panel-title">
          <h1>Inbox & Communications</h1>
          <div class="panel-subtitle">Messages, AI Chat & System Commands</div>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Today</div>
          </div>
          <div class="metric-value" id="msg-today">0</div>
        </div>
        
        <div class="metric-card green">
          <div class="metric-header">
            <div class="metric-label">Archived</div>
          </div>
          <div class="metric-value" id="msg-arch">0</div>
        </div>
        
        <div class="metric-card red">
          <div class="metric-header">
            <div class="metric-label">Errors</div>
          </div>
          <div class="metric-value" id="msg-err">0</div>
        </div>
        
        <div class="metric-card cyan">
          <div class="metric-header">
            <div class="metric-label">Chat Status</div>
          </div>
          <div style="font-size: 14px; font-weight: 500;" id="chat-status">Ready</div>
        </div>
        
        <div class="metric-card orange">
          <div class="metric-header">
            <div class="metric-label">Auto-Purge</div>
          </div>
          <div class="metric-controls">
            <select id="purge-select">
              <option value="1">1 day</option>
              <option value="7" selected>7 days</option>
              <option value="30">30 days</option>
            </select>
            <button id="purge-now" class="btn danger">Run</button>
          </div>
        </div>
      </div>

      <div class="inbox-comms-grid">
        <div class="glass-card">
          <div class="card-header">
            <h3 class="card-title">AI Assistant</h3>
            <svg class="icon" fill="none" viewBox="0 0 24 24" style="color: var(--accent-primary);">
              <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2v10z" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
          <div class="chat-input-group">
            <textarea 
              id="chat-input" 
              class="chat-input" 
              placeholder="Type your message to Jarvis AI... (Ctrl+Enter to send)"
              rows="1"></textarea>
            <button id="chat-send" class="btn primary">Send</button>
          </div>
        </div>

        <div class="glass-card">
          <div class="card-header">
            <h3 class="card-title">System Commands</h3>
            <svg class="icon" fill="none" viewBox="0 0 24 24" style="color: var(--accent-primary);">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
          <div class="wake-input-group">
            <div class="wake-prefix">jarvis</div>
            <input 
              type="text" 
              id="wake-input" 
              class="wake-input"
              placeholder="weather, digest, help..."
            />
            <button id="wake-send" class="btn primary">Execute</button>
          </div>
          <div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
            Last: <span id="last-wake">No commands sent</span>
          </div>
        </div>
      </div>

      <div class="inbox-layout">
        <div class="panel">
          <div class="panel-head">
            <div class="flex gap-4">
              <div class="checkbox-group">
                <input type="checkbox" id="pv-follow" checked />
                <label for="pv-follow">Auto-preview new messages</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="keep-arch" />
                <label for="keep-arch">Keep archived when deleting all</label>
              </div>
            </div>
            <button id="del-all" class="btn danger">Delete All Messages</button>
          </div>
          
          <table class="data-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Source</th>
                <th>Title</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="msg-body">
              <tr><td colspan="4" class="text-center text-muted">Loading messages...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="preview-panel">
          <div class="preview-header">
            <div>
              <div class="preview-title" id="pv-title">No message selected</div>
              <div class="preview-meta" id="pv-meta">—</div>
            </div>
          </div>
          <div class="preview-content" id="pv-body">
            <div class="text-center text-muted">Select a message to preview its contents</div>
          </div>
        </div>
      </div>
    </section>
    <!-- ORCHESTRATOR TAB - Keeping existing content -->
    <section id="orchestrator" class="tab-panel">
      <div class="panel-header">
        <div class="panel-title">
          <h1>Automation Orchestrator</h1>
          <div class="panel-subtitle">Manage servers, run playbooks, and schedule automated tasks</div>
        </div>
      </div>

      <div class="orch-tabs">
        <button class="orch-tab active" data-orch-tab="playbooks">Playbooks</button>
        <button class="orch-tab" data-orch-tab="servers">Servers</button>
        <button class="orch-tab" data-orch-tab="schedules">Schedules</button>
        <button class="orch-tab" data-orch-tab="history">History</button>
      </div>

      <div id="orch-playbooks" class="orch-panel active">
        <div class="panel" style="margin-bottom: 24px;">
          <div class="panel-head">
            <h3>Upload Playbooks</h3>
          </div>
          <div class="upload-zone" id="playbook-upload-zone">
            <input type="file" id="playbook-file-input" accept=".yml,.yaml,.sh,.py" multiple style="display: none;" />
            <svg class="icon" style="width: 48px; height: 48px; color: var(--accent-primary); margin-bottom: 12px;" fill="none" viewBox="0 0 24 24">
              <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px; color: var(--text-primary);">
              Drop playbook files here or click to browse
            </div>
            <div style="font-size: 13px; color: var(--text-muted);">
              Supports .yml, .yaml, .sh, .py files
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h3>Available Playbooks</h3>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="playbook-search" placeholder="Search playbooks..." style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--surface-secondary); color: var(--text-primary); width: 300px;" />
              <button class="btn primary" onclick="orchRefreshPlaybooks()">Refresh</button>
            </div>
          </div>
          <div id="playbooks-list" class="playbooks-grid">
            <div class="text-center text-muted">Loading playbooks...</div>
          </div>
        </div>

        <div class="panel" style="margin-top: 24px;">
          <div class="panel-head">
            <h3>Live Output</h3>
          </div>
          <div class="log-output" id="orch-logs"></div>
        </div>
      </div>

      <div id="orch-servers" class="orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Server Inventory</h3>
            <button class="btn primary" onclick="orchShowAddServer()">Add Server</button>
          </div>
          <div id="servers-list">
            <div class="text-center text-muted">Loading servers...</div>
          </div>
        </div>
      </div>

      <div id="orch-schedules" class="orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Job Schedules</h3>
            <button class="btn primary" onclick="orchShowAddSchedule()">Add Schedule</button>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Job Name</th>
                <th>Playbook</th>
                <th>Schedule</th>
                <th>Server Group</th>
                <th>Last Run</th>
                <th>Next Run</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="schedules-list">
              <tr><td colspan="8" class="text-center text-muted">Loading schedules...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="orch-history" class="orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Job History</h3>
            <div style="display: flex; gap: 8px;">
              <button class="btn" onclick="orchLoadHistory()">Refresh</button>
              <button class="btn" onclick="orchShowHistorySettings()">Manage History</button>
            </div>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Name / Playbook</th>
                <th>Status</th>
                <th>Started</th>
                <th>Completed</th>
                <th>Exit Code</th>
                <th>Triggered By</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="history-list">
              <tr><td colspan="7" class="text-center text-muted">Loading history...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS TAB - Keeping existing content -->
    <section id="analytics" class="tab-panel">
      <div class="panel-header">
        <div class="panel-title">
          <h1>Analytics & Monitoring</h1>
          <div class="panel-subtitle">Real-time homelab health monitoring and uptime tracking</div>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">Health Score</div>
          </div>
          <div class="metric-value" id="health-score" style="font-size: 48px;">0%</div>
        </div>
        
        <div class="metric-card green">
          <div class="metric-header">
            <div class="metric-label">Services Up</div>
          </div>
          <div class="metric-value" id="services-up">0</div>
        </div>
        
        <div class="metric-card red">
          <div class="metric-header">
            <div class="metric-label">Services Down</div>
          </div>
          <div class="metric-value" id="services-down">0</div>
        </div>
        
        <div class="metric-card cyan">
          <div class="metric-header">
            <div class="metric-label">Total Monitored</div>
          </div>
          <div class="metric-value" id="services-total">0</div>
        </div>
      </div>

      <div style="margin: 20px 0; display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn" onclick="analyticsResetHealth()" 
                style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: #f59e0b;">
          Reset Health Scores
        </button>
        <button class="btn" onclick="analyticsResetIncidents()" 
                style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444;">
          Clear All Incidents
        </button>
        
        <button class="btn" onclick="analyticsPurgeWeek()" 
                style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6;">
          Purge 1 Week
        </button>
        <button class="btn" onclick="analyticsPurgeMonth()" 
                style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6;">
          Purge 1 Month
        </button>
        <button class="btn" onclick="analyticsPurgeAll()" 
                style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444;">
          Purge ALL
        </button>
      </div>

      <div class="orch-tabs">
        <button class="orch-tab active" data-analytics-tab="dashboard">Dashboard</button>
        <button class="orch-tab" data-analytics-tab="services">Services</button>
        <button class="orch-tab" data-analytics-tab="incidents">Incidents</button>
      </div>

      <div id="analytics-dashboard" class="orch-panel active">
        <div class="panel">
          <div class="panel-head">
            <h3>Service Status Overview</h3>
            <button class="btn primary" onclick="analyticsRefresh()">Refresh</button>
          </div>
          <div id="analytics-services-grid" class="playbooks-grid">
            <div class="text-center text-muted">Loading services...</div>
          </div>
        </div>
      </div>

      <div id="analytics-services" class="orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Monitored Services</h3>
            <button class="btn primary" onclick="analyticsShowAddService()">Add Service</button>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Service Name</th>
                <th>Endpoint</th>
                <th>Type</th>
                <th>Interval</th>
                <th>Status</th>
                <th>Enabled</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="analytics-services-list">
              <tr><td colspan="7" class="text-center text-muted">Loading services...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="analytics-incidents" class="orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Recent Incidents (Last 7 Days)</h3>
            <button class="btn primary" onclick="analyticsLoadIncidents()">Refresh</button>
          </div>
          <div id="analytics-incidents-list" style="margin-top: 16px;">
            <div class="text-center text-muted">Loading incidents...</div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS TAB - FIXED -->
    <section id="settings" class="tab-panel">
      <div class="panel-header">
        <div class="panel-title">
          <h1>System Settings</h1>
          <div class="panel-subtitle">Configure Jarvis Prime modules and features</div>
        </div>
      </div>

      <!-- HA Readonly Banner -->
      <div id="settings-readonly-banner" style="display: none; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 24px;">⚠️</span>
          <div>
            <div style="color: #f59e0b; font-weight: 600; margin-bottom: 4px;">Home Assistant Mode - Read Only</div>
            <div style="color: var(--text-muted); font-size: 14px;">
              Settings are managed through the Home Assistant addon configuration UI. These values are displayed for reference only.
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Sub-tabs - FIXED: Changed settings-tab to orch-tab -->
      <div class="orch-tabs">
        <button class="orch-tab active" data-settings-tab="general">General</button>
        <button class="orch-tab" data-settings-tab="llm">LLM & AI</button>
        <button class="orch-tab" data-settings-tab="personality">Personality</button>
        <button class="orch-tab" data-settings-tab="integrations">Integrations</button>
        <button class="orch-tab" data-settings-tab="communications">Communications</button>
        <button class="orch-tab" data-settings-tab="monitoring">Monitoring</button>
        <button class="orch-tab" data-settings-tab="push">Push Notifications</button>
        <button class="orch-tab" data-settings-tab="backup">Backup & Restore</button>
      </div>

      <!-- GENERAL PANEL -->
      <div id="settings-general-panel" class="settings-panel orch-panel active">
        <div class="panel">
          <div class="panel-head">
            <h3>General Settings</h3>
          </div>
          
          <div style="padding: 20px;">
            <div class="form-group">
              <label class="form-label">Bot Name</label>
              <input type="text" id="set-bot-name" placeholder="Jarvis Prime">
            </div>
            
            <div class="form-group">
              <label class="form-label">Bot Icon</label>
              <input type="text" id="set-bot-icon" placeholder="🧠">
            </div>
            
            <div class="form-group">
              <label class="form-label">Jarvis App Name</label>
              <input type="text" id="set-jarvis-app-name" placeholder="Jarvis">
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-beautify-enabled" />
                <label for="set-beautify-enabled">Enable message beautification</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-beautify-inline-images" />
                <label for="set-beautify-inline-images">Show inline images in messages</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-silent-repost" />
                <label for="set-silent-repost">Silent repost (delete original messages after processing)</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-greeting-enabled" />
                <label for="set-greeting-enabled">Enable greeting messages</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Retention Days</label>
              <input type="number" id="set-retention-days" min="1" placeholder="30">
              <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                Number of days to keep messages in inbox
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Retention Hours (for hourly cleanup)</label>
              <input type="number" id="set-retention-hours" min="1" placeholder="24">
            </div>
            
            <div class="form-group">
              <label class="form-label">Auto-Purge Policy</label>
              <select id="set-auto-purge-policy">
                <option value="off">Off</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- LLM & AI PANEL -->
      <div id="settings-llm-panel" class="settings-panel orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>LLM & AI Configuration</h3>
          </div>
          
          <div style="padding: 20px;">
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-llm-enabled" />
                <label for="set-llm-enabled">Enable LLM processing</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-llm-persona-riffs-enabled" />
                <label for="set-llm-persona-riffs-enabled">Enable persona riffs (personality-based responses)</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-llm-rewrite-enabled" />
                <label for="set-llm-rewrite-enabled">Enable message rewriting</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Models Directory</label>
              <input type="text" id="set-llm-models-dir" placeholder="/share/jarvis_prime/models">
            </div>
            
            <div class="form-group">
              <label class="form-label">Timeout (seconds)</label>
              <input type="number" id="set-llm-timeout-seconds" min="1" placeholder="20">
            </div>
            
            <div class="form-group">
              <label class="form-label">Max CPU %</label>
              <input type="number" id="set-llm-max-cpu-percent" min="1" max="100" placeholder="80">
            </div>
            
            <div class="form-group">
              <label class="form-label">Context Tokens</label>
              <input type="number" id="set-llm-ctx-tokens" min="1" placeholder="6096">
            </div>
            
            <div class="form-group">
              <label class="form-label">Generation Tokens</label>
              <input type="number" id="set-llm-gen-tokens" min="1" placeholder="300">
            </div>
            
            <div class="form-group">
              <label class="form-label">Threads</label>
              <input type="number" id="set-llm-threads" min="1" placeholder="3">
            </div>
            
            <div class="form-group">
              <label class="form-label">Models Priority</label>
              <input type="text" id="set-llm-models-priority" placeholder="phi35_q5_uncensored,phi35_q5,phi35_q4,phi3">
              <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                Comma-separated list of model names in priority order
              </div>
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">EnviroGuard</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-llm-enviroguard-enabled" />
                <label for="set-llm-enviroguard-enabled">Enable EnviroGuard (temperature-based performance adjustment)</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Poll Interval (minutes)</label>
              <input type="number" id="set-llm-enviroguard-poll-minutes" min="1" placeholder="30">
            </div>
            
            <div class="form-group">
              <label class="form-label">Hot Temperature Threshold (°C)</label>
              <input type="number" id="set-llm-enviroguard-hot-c" placeholder="30">
            </div>
            
            <div class="form-group">
              <label class="form-label">Normal Temperature (°C)</label>
              <input type="number" id="set-llm-enviroguard-normal-c" placeholder="22">
            </div>
            
            <div class="form-group">
              <label class="form-label">Cold Temperature Threshold (°C)</label>
              <input type="number" id="set-llm-enviroguard-cold-c" placeholder="10">
            </div>
          </div>
        </div>
      </div>
      <!-- PERSONALITY PANEL -->
      <div id="settings-personality-panel" class="settings-panel orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Personality Settings</h3>
          </div>
          
          <div style="padding: 20px;">
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-personality-enabled" />
                <label for="set-personality-enabled">Enable personality system</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Active Persona</label>
              <select id="set-active-persona">
                <option value="auto">Auto</option>
                <option value="ops">Ops</option>
                <option value="dude">Dude</option>
                <option value="chick">Chick</option>
                <option value="nerd">Nerd</option>
                <option value="rager">Rager</option>
                <option value="comedian">Comedian</option>
                <option value="action">Action</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Min Interval Between Riffs (minutes)</label>
              <input type="number" id="set-personality-min-interval-minutes" min="1" placeholder="90">
            </div>
            
            <div class="form-group">
              <label class="form-label">Interval Jitter %</label>
              <input type="number" id="set-personality-interval-jitter-pct" min="0" max="100" placeholder="20">
            </div>
            
            <div class="form-group">
              <label class="form-label">Daily Max Riffs</label>
              <input type="number" id="set-personality-daily-max" min="1" placeholder="6">
            </div>
            
            <div class="form-group">
              <label class="form-label">Quiet Hours</label>
              <input type="text" id="set-personality-quiet-hours" placeholder="23:00-06:00">
              <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                Format: HH:MM-HH:MM (e.g., 23:00-06:00)
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-chat-enabled" />
                <label for="set-chat-enabled">Enable chat functionality</label>
              </div>
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Enabled Personas</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-enable-dude" />
                <label for="set-enable-dude">Enable Dude persona</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-enable-chick" />
                <label for="set-enable-chick">Enable Chick persona</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-enable-nerd" />
                <label for="set-enable-nerd">Enable Nerd persona</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-enable-rager" />
                <label for="set-enable-rager">Enable Rager persona</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-enable-comedian" />
                <label for="set-enable-comedian">Enable Comedian persona</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-enable-action" />
                <label for="set-enable-action">Enable Action persona</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- INTEGRATIONS PANEL -->
      <div id="settings-integrations-panel" class="settings-panel orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Integration Settings</h3>
          </div>
          
          <div style="padding: 20px;">
            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Weather</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-weather-enabled" />
                <label for="set-weather-enabled">Enable weather reports</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Latitude</label>
              <input type="number" id="set-weather-lat" step="0.0001" placeholder="-26.2041">
            </div>
            
            <div class="form-group">
              <label class="form-label">Longitude</label>
              <input type="number" id="set-weather-lon" step="0.0001" placeholder="28.0473">
            </div>
            
            <div class="form-group">
              <label class="form-label">City Name</label>
              <input type="text" id="set-weather-city" placeholder="Odendaalsrus">
            </div>
            
            <div class="form-group">
              <label class="form-label">Report Time</label>
              <input type="text" id="set-weather-time" placeholder="07:00">
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Daily Digest</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-digest-enabled" />
                <label for="set-digest-enabled">Enable daily digest</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Digest Time</label>
              <input type="text" id="set-digest-time" placeholder="08:00">
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Heartbeat</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-heartbeat-enabled" />
                <label for="set-heartbeat-enabled">Enable heartbeat messages</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Interval (minutes)</label>
              <input type="number" id="set-heartbeat-interval-minutes" min="1" placeholder="120">
            </div>
            
            <div class="form-group">
              <label class="form-label">Start Time</label>
              <input type="text" id="set-heartbeat-start" placeholder="06:00">
            </div>
            
            <div class="form-group">
              <label class="form-label">End Time</label>
              <input type="text" id="set-heartbeat-end" placeholder="20:00">
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Radarr</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-radarr-enabled" />
                <label for="set-radarr-enabled">Enable Radarr integration</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Radarr URL</label>
              <input type="text" id="set-radarr-url" placeholder="http://192.168.1.100:7878">
            </div>
            
            <div class="form-group">
              <label class="form-label">API Key</label>
              <input type="text" id="set-radarr-api-key" placeholder="Enter API key">
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Sonarr</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-sonarr-enabled" />
                <label for="set-sonarr-enabled">Enable Sonarr integration</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Sonarr URL</label>
              <input type="text" id="set-sonarr-url" placeholder="http://192.168.1.100:8989">
            </div>
            
            <div class="form-group">
              <label class="form-label">API Key</label>
              <input type="text" id="set-sonarr-api-key" placeholder="Enter API key">
            </div>
          </div>
        </div>
      </div>

      <!-- COMMUNICATIONS PANEL -->
      <div id="settings-communications-panel" class="settings-panel orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Communication Channels</h3>
          </div>
          
          <div style="padding: 20px;">
            <h4 style="margin-bottom: 16px; color: var(--text-primary);">SMTP Intake</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-smtp-enabled" />
                <label for="set-smtp-enabled">Enable SMTP server</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">SMTP Port</label>
              <input type="number" id="set-smtp-port" min="1" placeholder="2525">
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-ingest-smtp-enabled" />
                <label for="set-ingest-smtp-enabled">Enable SMTP message ingestion</label>
              </div>
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Proxy</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-proxy-enabled" />
                <label for="set-proxy-enabled">Enable proxy intake</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Proxy Port</label>
              <input type="number" id="set-proxy-port" min="1" placeholder="2580">
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Webhook</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-webhook-enabled" />
                <label for="set-webhook-enabled">Enable webhook intake</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Webhook Port</label>
              <input type="number" id="set-webhook-port" min="1" placeholder="2590">
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Apprise</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-intake-apprise-enabled" />
                <label for="set-intake-apprise-enabled">Enable Apprise intake server</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Apprise Port</label>
              <input type="number" id="set-intake-apprise-port" min="1" placeholder="2591">
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-ingest-apprise-enabled" />
                <label for="set-ingest-apprise-enabled">Enable Apprise message ingestion</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MONITORING PANEL -->
      <div id="settings-monitoring-panel" class="settings-panel orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Monitoring Services</h3>
          </div>
          
          <div style="padding: 20px;">
            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Uptime Kuma</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-uptimekuma-enabled" />
                <label for="set-uptimekuma-enabled">Enable Uptime Kuma integration</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Uptime Kuma URL</label>
              <input type="text" id="set-uptimekuma-url" placeholder="http://192.168.1.100:3001">
            </div>
            
            <div class="form-group">
              <label class="form-label">API Key</label>
              <input type="text" id="set-uptimekuma-api-key" placeholder="Enter API key">
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">Technitium DNS</h4>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-technitium-enabled" />
                <label for="set-technitium-enabled">Enable Technitium DNS integration</label>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Technitium URL</label>
              <input type="text" id="set-technitium-url" placeholder="http://192.168.1.100:5380">
            </div>
            
            <div class="form-group">
              <label class="form-label">API Key</label>
              <input type="text" id="set-technitium-api-key" placeholder="Enter API key">
            </div>
          </div>
        </div>
      </div>

      <!-- PUSH NOTIFICATIONS PANEL -->
      <div id="settings-push-panel" class="settings-panel orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Push Notification Services</h3>
          </div>
          
          <div style="padding: 20px;">
            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Gotify</h4>
            
            <div class="form-group">
              <label class="form-label">Gotify URL</label>
              <input type="text" id="set-gotify-url" placeholder="http://192.168.1.100:8091">
            </div>
            
            <div class="form-group">
              <label class="form-label">Client Token</label>
              <input type="text" id="set-gotify-client-token" placeholder="Enter client token">
            </div>
            
            <div class="form-group">
              <label class="form-label">App Token</label>
              <input type="text" id="set-gotify-app-token" placeholder="Enter app token">
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-push-gotify-enabled" />
                <label for="set-push-gotify-enabled">Enable Gotify push notifications</label>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-ingest-gotify-enabled" />
                <label for="set-ingest-gotify-enabled">Enable Gotify message ingestion</label>
              </div>
            </div>
            
            <h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--text-primary);">ntfy</h4>
            
            <div class="form-group">
              <label class="form-label">ntfy URL</label>
              <input type="text" id="set-ntfy-url" placeholder="http://192.168.1.100:8080">
            </div>
            
            <div class="form-group">
              <label class="form-label">ntfy Topic</label>
              <input type="text" id="set-ntfy-topic" placeholder="jarvis">
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="set-push-ntfy-enabled" />
                <label for="set-push-ntfy-enabled">Enable ntfy push notifications</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NEW: BACKUP & RESTORE PANEL -->
      <div id="settings-backup-panel" class="settings-panel orch-panel">
        <div class="panel">
          <div class="panel-head">
            <h3>Backup & Restore</h3>
          </div>
          
          <div style="padding: 20px;">
            <div style="background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <span style="font-size: 24px;">💾</span>
                <span style="color: #0ea5e9; font-weight: 600;">Full System Backup</span>
              </div>
              <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 0;">
                Create a complete backup of your Jarvis Prime installation including database, playbooks, models, and configuration.
              </p>
            </div>
            
            <div style="margin-bottom: 32px;">
              <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">Create Backup</h4>
              <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                Download a complete backup archive (.tar.gz) containing all system data.
              </p>
              <button id="backup-download-btn" class="btn primary" style="width: 100%;">
                📥 Download Full Backup
              </button>
            </div>
            
            <div style="padding-top: 24px; border-top: 1px solid var(--surface-border);">
              <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">Restore Backup</h4>
              <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                Upload a backup archive to restore your system. <strong style="color: var(--accent-primary);">This will overwrite all current data.</strong>
              </p>
              
              <div style="background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 18px;">⚠️</span>
                  <span style="color: #f59e0b; font-size: 13px; font-weight: 500;">
                    Jarvis will automatically restart after restore completes
                  </span>
                </div>
              </div>
              
              <input type="file" id="backup-file-input" accept=".tar.gz,.tgz" style="display: none;">
              <button id="backup-restore-btn" class="btn" style="width: 100%;">
                📤 Select Backup File to Restore
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Button (only visible in Docker mode) -->
      <div style="margin-top: 24px; padding: 20px; background: var(--surface-secondary); border-radius: 8px; display: flex; justify-content: flex-end; gap: 12px;">
        <button id="settings-save-btn" class="btn primary" onclick="settingsSaveConfig()">Save Settings</button>
      </div>
    </section>
  </main>

  <!-- ALL EXISTING MODALS (unchanged) -->
  <div id="server-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Server</h2>
        <button class="btn" onclick="orchCloseServerModal()">✕</button>
      </div>
      <form id="server-form" onsubmit="orchSaveServer(event)">
        <div class="form-group">
          <label class="form-label">Server Name *</label>
          <input type="text" id="srv-name" required placeholder="web-server-01">
        </div>
        <div class="form-group">
          <label class="form-label">IP Address / Hostname *</label>
          <input type="text" id="srv-host" required placeholder="192.168.1.100">
        </div>
        <div class="form-group">
          <label class="form-label">SSH Port</label>
          <input type="number" id="srv-port" value="22">
        </div>
        <div class="form-group">
          <label class="form-label">Username *</label>
          <input type="text" id="srv-user" required placeholder="root">
        </div>
        <div class="form-group">
          <label class="form-label">Password *</label>
          <input type="password" id="srv-pass" required placeholder="Enter SSH password">
        </div>
        <div class="form-group">
          <label class="form-label">Groups (comma-separated)</label>
          <input type="text" id="srv-groups" placeholder="web, production">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea id="srv-desc" rows="3" placeholder="Production web server"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" onclick="orchCloseServerModal()">Cancel</button>
          <button type="submit" class="btn primary">Save Server</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-server-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Server</h2>
        <button class="btn" onclick="orchCloseEditServerModal()">✕</button>
      </div>
      <form id="edit-server-form" onsubmit="orchUpdateServer(event)">
        <input type="hidden" id="edit-srv-id">
        <div class="form-group">
          <label class="form-label">Server Name *</label>
          <input type="text" id="edit-srv-name" required placeholder="web-server-01">
        </div>
        <div class="form-group">
          <label class="form-label">IP Address / Hostname *</label>
          <input type="text" id="edit-srv-host" required placeholder="192.168.1.100">
        </div>
        <div class="form-group">
          <label class="form-label">SSH Port</label>
          <input type="number" id="edit-srv-port" value="22">
        </div>
        <div class="form-group">
          <label class="form-label">Username *</label>
          <input type="text" id="edit-srv-user" required placeholder="root">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="edit-srv-pass" placeholder="Leave blank to keep current password">
          <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
            Only enter a new password if you want to change it
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Groups (comma-separated)</label>
          <input type="text" id="edit-srv-groups" placeholder="web, production">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea id="edit-srv-desc" rows="3" placeholder="Production web server"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" onclick="orchCloseEditServerModal()">Cancel</button>
          <button type="submit" class="btn primary">Update Server</button>
        </div>
      </form>
    </div>
  </div>

  <div id="schedule-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create Schedule</h2>
        <button class="btn" onclick="orchCloseScheduleModal()">✕</button>
      </div>
      <form id="schedule-form" onsubmit="orchSaveSchedule(event)">
        <div class="form-group">
          <label class="form-label">Job Name *</label>
          <input type="text" id="sched-name" required placeholder="Weekly Apt Update">
          <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
            Give this schedule a friendly name (e.g., "Daily Backup", "Weekly Update")
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Playbook *</label>
          <select id="sched-playbook" required>
            <option value="">Select a playbook...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Server Group</label>
          <input type="text" id="sched-group" placeholder="web, all (optional)">
        </div>
        
        <div class="form-group">
          <label class="form-label">Schedule Preset</label>
          <select id="sched-preset" onchange="orchApplyPreset()">
            <option value="">Custom...</option>
            <option value="0 2 * * *">Every day at 2 AM</option>
            <option value="0 8 * * 1">Every Monday at 8 AM</option>
            <option value="0 0 * * *">Daily at midnight</option>
            <option value="0 */6 * * *">Every 6 hours</option>
            <option value="0 * * * *">Every hour</option>
            <option value="*/15 * * * *">Every 15 minutes</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Cron Expression *</label>
          <input type="text" id="sched-cron" required placeholder="0 2 * * *" pattern="[0-9\*\-\,\/ ]+">
          <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
            Format: minute hour day month weekday (e.g., "0 2 * * *" = 2 AM daily)
          </div>
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="sched-notify" checked />
            <label for="sched-notify">Send notification when job completes</label>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn" onclick="orchCloseScheduleModal()">Cancel</button>
          <button type="submit" class="btn primary">Save Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <div id="history-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Manage History</h2>
        <button class="btn" onclick="orchCloseHistoryModal()">✕</button>
      </div>
      
      <div class="form-group">
        <label class="form-label">Quick Actions</label>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          <button class="btn" onclick="orchPurgeHistory('failed')">Delete Failed Jobs</button>
          <button class="btn" onclick="orchPurgeHistory('completed')">Delete Successful Jobs</button>
          <button class="btn" onclick="orchPurgeHistory('older_than_30')">Delete Older Than 30 Days</button>
          <button class="btn" onclick="orchPurgeHistory('older_than_90')">Delete Older Than 90 Days</button>
        </div>
      </div>

      <div style="background: var(--surface-tertiary); border-radius: 8px; padding: 16px; margin: 20px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: var(--text-muted); font-size: 14px;">Total Entries:</span>
          <span id="history-total" style="color: var(--text-primary); font-weight: 600;">—</span>
        </div>
      </div>

      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 16px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span style="font-size: 24px;">⚠️</span>
          <span style="color: #ef4444; font-weight: 600;">Danger Zone</span>
        </div>
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">
          Permanently delete all execution history. This action cannot be undone.
        </p>
        <button class="btn danger" style="width: 100%;" onclick="orchPurgeHistory('all')">Delete ALL History</button>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn" onclick="orchCloseHistoryModal()">Close</button>
      </div>
    </div>
  </div>

  <div id="job-output-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h2 id="job-output-title">Job Output</h2>
        <button class="btn" onclick="orchCloseJobOutputModal()">✕</button>
      </div>
      <div style="margin-bottom: 16px;">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 12px; background: var(--surface-tertiary); border-radius: 8px;">
          <div>
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Status</div>
            <div id="job-output-status">—</div>
          </div>
          <div>
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Exit Code</div>
            <div id="job-output-exit-code">—</div>
          </div>
          <div>
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Started</div>
            <div id="job-output-started">—</div>
          </div>
          <div>
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Completed</div>
            <div id="job-output-completed">—</div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Output</label>
        <div class="log-output" id="job-output-content" style="max-height: 500px; min-height: 200px;">
          <div class="text-center text-muted">No output</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="orchCloseJobOutputModal()">Close</button>
      </div>
    </div>
  </div>

  <div id="analytics-service-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="analytics-service-modal-title">Add Service</h2>
        <button class="btn" onclick="analyticsCloseServiceModal()">✕</button>
      </div>
      <form id="analytics-service-form" onsubmit="analyticsSaveService(event)">
        <input type="hidden" id="analytics-service-id">
        
        <div class="form-group">
          <label class="form-label">Service Name *</label>
          <input type="text" id="analytics-service-name" required placeholder="Home Assistant">
        </div>
        
        <div class="form-group">
          <label class="form-label">Endpoint *</label>
          <input type="text" id="analytics-service-endpoint" required placeholder="http://homeassistant.local:8123 or 192.168.1.100:22 or 8.8.8.8">
          <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
            HTTP: Full URL with protocol • TCP: host:port • Ping: hostname or IP
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Check Type *</label>
          <select id="analytics-check-type" required onchange="analyticsToggleStatusCode()">
            <option value="http">HTTP - Web endpoint</option>
            <option value="tcp">TCP - Port check</option>
            <option value="ping">ICMP Ping - Host reachability</option>
          </select>
        </div>
        
        <div class="form-group" id="analytics-status-code-group">
          <label class="form-label">Expected HTTP Status Code</label>
          <input type="number" id="analytics-expected-status" value="200" min="100" max="599">
        </div>
        
        <div class="form-group">
          <label class="form-label">Check Interval (seconds)</label>
          <input type="number" id="analytics-check-interval" value="60" min="10" max="3600">
        </div>
        
        <div class="form-group">
          <label class="form-label">Timeout (seconds)</label>
          <input type="number" id="analytics-check-timeout" value="5" min="1" max="30">
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="analytics-service-enabled" checked />
            <label for="analytics-service-enabled">Enable monitoring for this service</label>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn" onclick="analyticsCloseServiceModal()">Cancel</button>
          <button type="submit" class="btn primary">Save Service</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast"></div>
  
  <!-- Scripts -->
  <script src="app.js?v=5.0"></script>
  <script src="orchestrator.js?v=1.3"></script>
  <script src="analytics.js?v=1.0"></script>
  <script src="settings.js?v=1.0"></script>
</body>
</html>
