<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Remote Linux Backup</title>
  <link rel="stylesheet" href="/www/style.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="brand__logo" aria-hidden="true"></div>
        <div>
          <h1 class="brand__title">Remote Linux Backup</h1>
          <p class="brand__subtitle">Back up &amp; restore remote Linux (dd, rsync, ZFS) with NAS mounts, Dropbox, scheduler &amp; Gotify.</p>
        </div>
      </div>
      <nav class="tabs" role="tablist" aria-label="Sections">
        <button class="tab is-active" data-tab="backup" role="tab" aria-selected="true">Backup</button>
        <button class="tab" data-tab="restore" role="tab">Restore</button>
        <button class="tab" data-tab="jobs" role="tab">Jobs</button>
        <button class="tab" data-tab="settings" role="tab">Settings</button>
      </nav>
    </header>

    <!-- BACKUP -->
    <section id="backup" class="panel is-active" role="tabpanel" aria-labelledby="Backup">
      <div class="grid">
        <div class="field">
          <label>Host/IP <span class="hint">Remote server to back up</span></label>
          <input id="b-host" placeholder="10.0.0.21" />
        </div>
        <div class="field">
          <label>User <span class="hint">SSH username</span></label>
          <input id="b-user" value="root" />
        </div>
        <div class="field">
          <label>Password <span class="hint">SSH password (no keys required)</span></label>
          <input id="b-pass" type="password" />
        </div>
        <div class="field">
          <label>Method <span class="hint">dd = full disk image; rsync = files; ZFS = snapshot</span></label>
          <select id="b-method">
            <option value="dd">Full Disk (dd)</option>
            <option value="rsync">Files (rsync)</option>
            <option value="zfs">ZFS Snapshot</option>
          </select>
        </div>

        <div class="field" id="b-disk-wrap">
          <label>Disk device <span class="hint">Only for dd</span></label>
          <input id="b-disk" value="/dev/sda" />
        </div>
        <div class="field hide" id="b-files-wrap">
          <label>Paths (comma separated) <span class="hint">Only for rsync</span></label>
          <input id="b-files" value="/etc,/var/backups" />
        </div>
        <div class="field hide" id="b-zfs-wrap">
          <label>ZFS dataset <span class="hint">e.g. rpool/ROOT/pve-1</span></label>
          <input id="b-zfs" placeholder="tank/data" />
        </div>

        <div class="field">
          <label>Store to (local/NAS path) <span class="hint">Where images/files are saved inside the add-on</span></label>
          <input id="b-store" value="/backup" />
        </div>
        <div class="field">
          <label>Dropbox remote (optional) <span class="hint">rclone remote, e.g. dropbox:/HA-Backups/Proxmox</span></label>
          <input id="b-cloud" placeholder="dropbox:/HA-Backups/Proxmox" />
        </div>
      </div>

      <div class="actions">
        <button id="btn-probe" class="btn">Probe host</button>
        <button id="btn-tools" class="btn">Auto-install tools</button>
        <button id="btn-backup" class="btn btn--primary">Run backup</button>
      </div>

      <div class="log-wrap">
        <div class="log-title">Result</div>
        <pre id="backup-log" class="log" aria-live="polite"></pre>
      </div>
    </section>

    <!-- RESTORE -->
    <section id="restore" class="panel" role="tabpanel" aria-labelledby="Restore">
      <div class="grid">
        <div class="field">
          <label>Host/IP <span class="hint">Remote server to restore to</span></label>
          <input id="r-host" placeholder="10.0.0.21" />
        </div>
        <div class="field">
          <label>User</label>
          <input id="r-user" value="root" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="r-pass" type="password" />
        </div>
        <div class="field">
          <label>Method</label>
          <select id="r-method">
            <option value="dd">Restore Disk (dd)</option>
            <option value="rsync">Restore Files (rsync)</option>
          </select>
        </div>

        <div class="field" id="r-image-wrap">
          <label>Image path (.img.gz) <span class="hint">For dd restore</span></label>
          <input id="r-image" placeholder="/mnt/nas/proxmox-20250101.img.gz" />
        </div>
        <div class="field" id="r-disk-wrap">
          <label>Disk device <span class="hint">Target device on remote host</span></label>
          <input id="r-disk" value="/dev/sda" />
        </div>
        <div class="field hide" id="r-src-wrap">
          <label>Local source dir <span class="hint">Folder inside the add-on to push via rsync</span></label>
          <input id="r-src" placeholder="/backup/opnsense" />
        </div>
        <div class="field hide" id="r-dest-wrap">
          <label>Remote destination <span class="hint">Path on the remote host</span></label>
          <input id="r-dest" value="/" />
        </div>
      </div>

      <div class="actions">
        <button id="btn-run-restore" class="btn btn--primary">Run restore</button>
      </div>

      <div class="log-wrap">
        <div class="log-title">Result</div>
        <pre id="restore-log" class="log" aria-live="polite"></pre>
      </div>
    </section>

    <!-- JOBS -->
    <section id="jobs" class="panel" role="tabpanel" aria-labelledby="Jobs">
      <p class="help">
        <strong>Jobs</strong> run on a schedule (cron). Each line can be either JSON or simple
        <code>key=value;key=value</code>. Required: <code>host</code>, <code>username</code>, <code>password</code>, <code>method</code>, <code>schedule</code>.
      </p>
      <details class="help details">
        <summary>Examples</summary>
        <pre class="code">
# rsync files hourly
host=10.0.0.21;username=root;password=pass;method=rsync;files=/etc;store_to=/mnt/nas/test;schedule=5 * * * *

# full disk dd nightly + Dropbox
host=10.0.0.30;username=root;password=pass;method=dd;disk=/dev/sda;store_to=/mnt/nas/proxmox;schedule=0 2 * * *;cloud_upload=dropbox:/HA-Backups/Proxmox
        </pre>
      </details>

      <textarea id="jobs-json" class="textarea" rows="10" placeholder="One job per line"></textarea>

      <div class="actions">
        <button id="btn-save-jobs" class="btn">Save jobs</button>
        <button id="btn-apply" class="btn btn--primary">Apply schedule</button>
      </div>

      <div class="log-wrap">
        <div class="log-title">Scheduler</div>
        <pre id="jobs-log" class="log"></pre>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="panel" role="tabpanel" aria-labelledby="Settings">
      <div class="grid">
        <div class="field">
          <label>UI Port <span class="hint">Non-Ingress port</span></label>
          <input id="s-port" value="8066" />
        </div>
        <div class="field">
          <label>Gotify URL <span class="hint">http://host:port</span></label>
          <input id="s-gurl" placeholder="http://10.0.0.99:8091" />
        </div>
        <div class="field">
          <label>Gotify Token</label>
          <input id="s-gtok" placeholder="token" />
        </div>
        <div class="field">
          <label>Dropbox enabled</label>
          <select id="s-dbxe">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div class="field">
          <label>Dropbox remote <span class="hint">e.g. dropbox:HA-Backups</span></label>
          <input id="s-dbxr" value="dropbox:HA-Backups" />
        </div>
      </div>

      <div class="actions">
        <button id="btn-save" class="btn">Save settings</button>
        <button id="btn-list" class="btn">List local backups</button>
      </div>

      <div class="log-wrap">
        <div class="log-title">Status</div>
        <pre id="settings-log" class="log"></pre>
      </div>

      <details class="help details">
        <summary>NAS mounts (configure in add-on Configuration)</summary>
        <p>
          Add mounts under the add-onâ€™s <strong>Configuration</strong>. One line per mount:
          <code>proto=cifs;server=192.168.1.10;share=backups;mount=/mnt/nas;username=nasuser;password=pass</code><br/>
          NFS: <code>proto=nfs;server=192.168.1.20;share=/export/backups;mount=/mnt/nfs</code>
        </p>
      </details>
    </section>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const show = (el, v) => el.classList.toggle('hide', !v);

    // Tabs
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('is-active'));
        btn.classList.add('is-active');
        const tab = btn.dataset.tab;
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('is-active'));
        document.getElementById(tab).classList.add('is-active');
      });
    });

    // Field visibility
    $('#b-method').addEventListener('change', e => {
      const m = e.target.value;
      show($('#b-disk-wrap'), m === 'dd');
      show($('#b-files-wrap'), m === 'rsync');
      show($('#b-zfs-wrap'), m === 'zfs');
    });
    $('#r-method').addEventListener('change', e => {
      const m = e.target.value;
      show($('#r-image-wrap'), m === 'dd');
      show($('#r-disk-wrap'), m === 'dd');
      show($('#r-src-wrap'), m === 'rsync');
      show($('#r-dest-wrap'), m === 'rsync');
    });

    // API helpers
    async function POST(url, body) {
      const r = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body || {}) });
      return r.json().catch(() => ({}));
    }
    async function GET(url) {
      const r = await fetch(url);
      return r.json().catch(() => ({}));
    }

    // Actions
    $('#btn-probe').onclick = async () => {
      const payload = { host: $('#b-host').value, username: $('#b-user').value, password: $('#b-pass').value };
      const j = await POST('/api/probe_host', payload);
      $('#backup-log').textContent = j.out || JSON.stringify(j, null, 2);
    };

    $('#btn-tools').onclick = async () => {
      const payload = { host: $('#b-host').value, username: $('#b-user').value, password: $('#b-pass').value };
      const j = await POST('/api/install_tools', payload);
      $('#backup-log').textContent = j.out || JSON.stringify(j, null, 2);
    };

    $('#btn-backup').onclick = async () => {
      const p = {
        method: $('#b-method').value,
        host: $('#b-host').value, username: $('#b-user').value, password: $('#b-pass').value,
        store_to: $('#b-store').value, cloud_upload: $('#b-cloud').value,
        disk: $('#b-disk').value, files: $('#b-files').value, zfs_dataset: $('#b-zfs').value
      };
      const j = await POST('/api/run_backup', p);
      $('#backup-log').textContent = JSON.stringify(j, null, 2);
    };

    $('#btn-run-restore').onclick = async () => {
      const p = {
        method: $('#r-method').value,
        host: $('#r-host').value, username: $('#r-user').value, password: $('#r-pass').value,
        image_path: $('#r-image').value, disk: $('#r-disk').value,
        local_src: $('#r-src').value, remote_dest: $('#r-dest').value
      };
      const j = await POST('/api/run_restore', p);
      $('#restore-log').textContent = JSON.stringify(j, null, 2);
    };

    $('#btn-save').onclick = async () => {
      const p = {
        ui_port: parseInt($('#s-port').value || '8066', 10),
        gotify_enabled: !!($('#s-gurl').value && $('#s-gtok').value),
        gotify_url: $('#s-gurl').value,
        gotify_token: $('#s-gtok').value,
        dropbox_enabled: $('#s-dbxe').value === 'true',
        dropbox_remote: $('#s-dbxr').value
      };
      const j = await POST('/api/options', p);
      $('#settings-log').textContent = j.ok ? 'Saved.' : JSON.stringify(j);
    };

    $('#btn-list').onclick = async () => {
      const j = await GET('/api/list_backups?path=/backup');
      $('#settings-log').textContent = (j || []).map(x => `${x.path} (${x.size} bytes)`).join('\n');
    };

    $('#btn-save-jobs').onclick = async () => {
      const lines = ($('#jobs-json').value || '').split('\n').map(s => s.trim()).filter(Boolean);
      const opts = await GET('/api/options');
      opts.jobs = lines;
      const j = await POST('/api/options', opts);
      $('#jobs-log').textContent = j.ok ? 'Jobs saved. Click "Apply schedule".' : JSON.stringify(j);
    };

    $('#btn-apply').onclick = async () => {
      const j = await POST('/api/apply_schedule');
      $('#jobs-log').textContent = j.out || JSON.stringify(j, null, 2);
    };
  </script>
</body>
</html>