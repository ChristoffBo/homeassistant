<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Remote Linux Backup</title>
  <style>
    :root{--bg:#0e1621;--panel:#111b27;--text:#e6eef8;--muted:#9fb3c8;--accent:#4ea1ff;--danger:#ff6b6b;--ok:#22c55e;--line:#233242}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .topbar{display:flex;gap:.5rem;align-items:center;padding:.6rem;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--bg);z-index:10}
    .tab{padding:.45rem .8rem;border:1px solid var(--line);background:var(--panel);border-radius:.5rem;color:var(--muted);cursor:pointer}
    .tab.active{color:var(--text);border-color:var(--accent);outline:2px solid rgba(78,161,255,.2)}
    .wrap{max-width:1280px;margin:0 auto;padding:1rem}
    .panel{display:none}
    .panel.active{display:block}
    h2{margin:.3rem 0 1rem}
    .card{background:var(--panel);border:1px solid var(--line);padding:1rem;border-radius:.8rem;margin:0 0 1rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
    .row .card{margin:0}
    label{display:block;margin:.3rem 0 .3rem;color:var(--muted)}
    input,select,button,textarea{width:100%;padding:.55rem .65rem;border-radius:.5rem;border:1px solid var(--line);background:#0b1320;color:var(--text)}
    .btn{cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#001a33}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#330000}
    .btn.ghost{background:transparent}
    .grid{display:grid;gap:.6rem}
    .grid-cols-3{grid-template-columns:repeat(3,1fr)}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:.55rem;text-align:left}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .progress{height:.5rem;background:#0b1320;border:1px solid var(--line);border-radius:.5rem;overflow:hidden}
    .progress > span{display:block;height:100%;background:var(--accent);width:0}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.open{display:flex}
    .dialog{width:min(920px,95vw);max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:.8rem}
    .dialog header{display:flex;justify-content:space-between;align-items:center;padding:.8rem 1rem;border-bottom:1px solid var(--line)}
    .dialog .body{padding:0}
    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;align-items:center;gap:.6rem;padding:.6rem 1rem;border-bottom:1px solid var(--line);cursor:pointer}
    .list li:hover{background:#0b1320}
    .pill{display:inline-block;padding:.15rem .45rem;border:1px solid var(--line);border-radius:.5rem;margin-left:.4rem;color:var(--muted)}
    .right{margin-left:auto}
    code{background:#0b1320;border:1px solid var(--line);padding:.15rem .35rem;border-radius:.35rem}
  </style>
</head>
<body>
  <div class="topbar">
    <button class="tab active" data-tab="backup">Backup</button>
    <button class="tab" data-tab="backups">Backups</button>
    <button class="tab" data-tab="destinations">Backup Destinations</button>
    <button class="tab" data-tab="schedule">Schedule</button>
    <button class="tab" data-tab="alerts">Alerts</button>
    <button class="tab" data-tab="help">Help</button>
    <span class="right muted" id="statusLine">Idle</span>
  </div>

  <div class="wrap">
    <!-- Backup -->
    <section id="panel-backup" class="panel active">
      <h2>Backup Wizard</h2>
      <div class="row">
        <div class="card grid">
          <div class="grid">
            <label>Source type</label>
            <select id="srcType">
              <option value="ssh">SSH (remote)</option>
              <option value="local">Local (this HA)</option>
              <option value="mount">Mounted share</option>
            </select>
          </div>
          <div class="grid">
            <label>Profile <span class="pill">sets safe defaults</span></label>
            <select id="profile">
              <option>Generic Linux</option>
              <option>OPNsense</option>
              <option>Proxmox</option>
              <option>Unraid</option>
            </select>
          </div>

          <div class="grid">
            <label>Host/IP</label>
            <input id="srcHost" placeholder="e.g. 10.0.0.21">
          </div>
          <div class="grid">
            <label>User</label>
            <input id="srcUser" value="root">
          </div>

          <div class="grid">
            <label>Password</label>
            <input id="srcPass" type="password">
          </div>
          <div class="grid">
            <label>Dry run</label>
            <select id="dryRun"><option value="no">No</option><option value="yes">Yes</option></select>
          </div>

          <div class="grid">
            <label>Mode</label>
            <select id="mode">
              <option value="rsync">Rsync (SSH) — files</option>
              <option value="copy">Copy (rsync) — files & folders</option>
              <option value="dd">DD (image) — disk/partition</option>
            </select>
          </div>
          <div class="grid">
            <label>Label (optional)</label>
            <input id="label" placeholder="e.g. after-upgrade">
          </div>

          <div class="grid">
            <label>Source path / device</label>
            <input id="srcPath" value="/" placeholder="/ or /dev/sda">
            <div class="toolbar">
              <button class="btn" id="btnBrowseSSH">Browse (SSH)</button>
              <button class="btn" id="btnPickLocal">Pick local</button>
              <button class="btn" id="btnPickFromMount">Pick from mount</button>
              <button class="btn" id="btnTestSSH">Test SSH</button>
            </div>
          </div>
        </div>

        <div class="card grid">
          <div class="grid">
            <label>Destination type</label>
            <select id="dstType">
              <option value="local">Local (this HA)</option>
              <option value="mount">Mounted share</option>
            </select>
          </div>
          <div class="grid">
            <label>Destination mount (when using mounted share)</label>
            <select id="dstMount"><option value="">—</option></select>
          </div>
          <div class="grid">
            <label>Destination folder (base)</label>
            <input id="dstFolder" value="/config/remote_linux_backup/backups">
            <div class="toolbar">
              <button class="btn" id="btnDstPickLocal">Pick local</button>
              <button class="btn" id="btnDstPickFromMount">Pick from mount</button>
              <button class="btn" id="btnDstCreate">Create folder…</button>
            </div>
          </div>
          <div class="grid">
            <label>Bandwidth limit (KB/s)</label>
            <input id="bw" type="number" value="0">
          </div>
          <div class="grid">
            <label>Run</label>
            <div class="toolbar">
              <button class="btn primary" id="btnStart">Start</button>
              <button class="btn danger" id="btnCancel">Cancel Job</button>
              <button class="btn" id="btnEstimate">Estimate size</button>
            </div>
          </div>
          <div class="grid">
            <label>Progress</label>
            <div class="progress"><span id="progressBar"></span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Backups -->
    <section id="panel-backups" class="panel">
      <h2>Backups</h2>
      <div class="card">
        <table id="tblBackups">
          <thead><tr><th>Label</th><th>When</th><th>Size</th><th>Mode</th><th>Source</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Destinations -->
    <section id="panel-destinations" class="panel">
      <h2>Backup Destinations</h2>
      <div class="card">
        <div class="toolbar" style="justify-content:space-between">
          <div class="toolbar">
            <button class="btn" id="btnMountRefresh">Refresh</button>
            <button class="btn" id="btnBrowseMounted">Browse mounted…</button>
          </div>
          <div class="muted">Auto-retry is handled in the backend.</div>
        </div>
        <table id="tblMounts">
          <thead><tr><th>Name</th><th>Type</th><th>Host</th><th>Share/Export</th><th>Status</th><th>Mountpoint</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Schedule -->
    <section id="panel-schedule" class="panel">
      <h2>Schedule</h2>
      <div class="card grid grid-cols-3">
        <div><label>Max concurrent jobs</label><input id="schedMax" type="number" value="1"></div>
        <div><label>Default bwlimit (KB/s)</label><input id="schedBw" type="number" value="0"></div>
        <div style="display:flex;align-items:flex-end"><button class="btn primary" id="btnSchedSave">Save</button></div>
      </div>
      <div class="card">
        <table id="tblSchedules"><thead><tr><th>Name</th><th>When</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <!-- Alerts -->
    <section id="panel-alerts" class="panel">
      <h2>Alerts (Gotify)</h2>
      <div class="card grid grid-cols-3">
        <div><label>Server URL</label><input id="gotifyUrl" placeholder="http(s)://host:port/"></div>
        <div><label>App Token</label><input id="gotifyToken" placeholder="token"></div>
        <div><label>Enabled</label><select id="gotifyOn"><option value="1">Yes</option><option value="0">No</option></select></div>
        <div class="grid" style="grid-column:1/4">
          <label>Include in message</label>
          <div class="toolbar">
            <label><input type="checkbox" id="gf_time" checked> time</label>
            <label><input type="checkbox" id="gf_size" checked> size</label>
            <label><input type="checkbox" id="gf_name" checked> backup name</label>
            <label><input type="checkbox" id="gf_duration" checked> duration</label>
            <label><input type="checkbox" id="gf_status" checked> status</label>
          </div>
        </div>
        <div style="grid-column:1/4;display:flex;gap:.5rem">
          <button class="btn primary" id="btnGotifySave">Save</button>
          <button class="btn" id="btnGotifyTest">Send test</button>
        </div>
      </div>
    </section>

    <!-- Help -->
    <section id="panel-help" class="panel">
      <h2>Help</h2>
      <div class="card">
        <p>Each tab describes what it does. Backups are always restorable even without this UI.</p>
        <p><b>Disaster recovery for dd images</b>:
          Write the image to a disk/USB using <code>dd if=image.dd of=/dev/sdX bs=4M status=progress conv=fsync</code>.
        </p>
        <p><b>Rsync file copies</b>: contents are plain files; restore by copying back with rsync or your file manager.</p>
        <p>For issues, check logs at the bottom of each tab and the add-on log in Supervisor.</p>
      </div>
    </section>
  </div>

  <!-- Modal for pickers -->
  <div class="modal" id="pickerModal">
    <div class="dialog">
      <header>
        <div><b id="pickerTitle">Picker</b> <span class="pill" id="pickerPath"></span></div>
        <button class="tab" id="pickerClose">✕</button>
      </header>
      <div class="body">
        <ul class="list" id="pickerList"></ul>
      </div>
      <div style="padding:.8rem;border-top:1px solid var(--line);display:flex;gap:.5rem;justify-content:flex-end">
        <button class="btn" id="pickerUp">Up</button>
        <button class="btn primary" id="pickerChoose">Choose</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
