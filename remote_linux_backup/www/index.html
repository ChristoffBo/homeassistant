<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Remote Linux Backup</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="page">
    <div class="card">
      <header class="card__header">
        <div class="brand__logo" aria-hidden="true"></div>
        <div>
          <h1 class="brand__title">Remote Linux Backup</h1>
          <p class="brand__subtitle">Back up remote Linux servers via SSH. Full disk (dd), files (rsync), ZFS snapshots. NAS mounts, Dropbox, scheduler &amp; Gotify.</p>
        </div>
      </header>

      <nav class="tabs" role="tablist" aria-label="Sections">
        <button class="tab is-active" data-tab="backup" role="tab" aria-selected="true">Backup</button>
        <button class="tab" data-tab="restore" role="tab">Restore</button>
        <button class="tab" data-tab="jobs" role="tab">Jobs</button>
        <button class="tab" data-tab="mounts" role="tab">Mounts</button>
        <button class="tab" data-tab="hosts" role="tab">Known Hosts</button>
        <button class="tab" data-tab="settings" role="tab">Settings</button>
      </nav>

      <!-- BACKUP -->
      <section id="backup" class="panel is-active" role="tabpanel" aria-labelledby="Backup">
        <div class="form">
          <div class="field"><label>Backup from (Host/IP) <span class="hint">Remote server address</span></label><input id="b-host" placeholder="10.0.0.21" /></div>
          <div class="field"><label>SSH user <span class="hint">e.g. root</span></label><input id="b-user" value="root" /></div>
          <div class="field"><label>SSH password</label><input id="b-pass" type="password" /></div>
          <div class="field">
            <label>Method <span class="hint">dd = disk image · rsync = files · ZFS = snapshot</span></label>
            <select id="b-method">
              <option value="dd">Full Disk (dd)</option>
              <option value="rsync">Files (rsync)</option>
              <option value="zfs">ZFS Snapshot</option>
            </select>
          </div>
          <div class="field" id="b-disk-wrap"><label>Disk device <span class="hint">For dd, e.g. /dev/sda</span></label><input id="b-disk" value="/dev/sda" /></div>
          <div class="field hide" id="b-files-wrap"><label>Paths (comma separated) <span class="hint">For rsync, e.g. /etc,/var/log</span></label><input id="b-files" value="/etc,/var/backups" /></div>
          <div class="field hide" id="b-zfs-wrap"><label>ZFS dataset <span class="hint">e.g. tank/data</span></label><input id="b-zfs" /></div>
          <div class="field"><label>Store to <span class="hint">Local/NAS path inside add-on (e.g. /backup or /mnt/nas/name)</span></label><input id="b-store" value="/backup" /></div>
          <div class="field"><label>Cloud (rclone remote) <span class="hint">Optional, e.g. dropbox:/HA-Backups</span></label><input id="b-cloud" /></div>
          <div class="field">
            <label>Use preset <span class="hint">Quick-fill from Known Hosts</span></label>
            <select id="b-preset"><option value="">—</option></select>
          </div>
        </div>

        <div class="actions">
          <button id="btn-probe" class="btn">Probe host</button>
          <button id="btn-tools" class="btn">Auto-install tools</button>
          <button id="btn-backup" class="btn btn--primary">Run backup</button>
        </div>

        <div class="log-wrap">
          <div class="log-title">Result</div>
          <pre id="backup-log" class="log" aria-live="polite"></pre>
        </div>
      </section>

      <!-- RESTORE -->
      <section id="restore" class="panel" role="tabpanel" aria-labelledby="Restore">
        <div class="form">
          <div class="field"><label>Restore to (Host/IP)</label><input id="r-host" placeholder="10.0.0.21" /></div>
          <div class="field"><label>SSH user</label><input id="r-user" value="root" /></div>
          <div class="field"><label>SSH password</label><input id="r-pass" type="password" /></div>
          <div class="field">
            <label>Method</label>
            <select id="r-method">
              <option value="dd">Restore Disk (dd)</option>
              <option value="rsync">Restore Files (rsync)</option>
            </select>
          </div>
          <div class="field" id="r-image-wrap"><label>Image path (.img.gz) <span class="hint">For dd restore</span></label><input id="r-image" /></div>
          <div class="field" id="r-disk-wrap"><label>Disk device</label><input id="r-disk" value="/dev/sda" /></div>
          <div class="field hide" id="r-src-wrap"><label>Local source dir <span class="hint">Folder inside add-on</span></label><input id="r-src" placeholder="/backup/opnsense" /></div>
          <div class="field hide" id="r-dest-wrap"><label>Remote destination</label><input id="r-dest" value="/" /></div>
        </div>

        <div class="actions">
          <button id="btn-run-restore" class="btn btn--primary">Run restore</button>
        </div>

        <div class="log-wrap">
          <div class="log-title">Result</div>
          <pre id="restore-log" class="log"></pre>
        </div>
      </section>

      <!-- JOBS -->
      <section id="jobs" class="panel" role="tabpanel" aria-labelledby="Jobs">
        <p class="help">
          Create scheduled backups. No JSON editing needed.
        </p>

        <div class="form">
          <div class="field"><label>Job name</label><input id="j-name" placeholder="nightly-proxmox" /></div>
          <div class="field"><label>Host/IP</label><input id="j-host" placeholder="10.0.0.21" /></div>
          <div class="field"><label>SSH user</label><input id="j-user" value="root" /></div>
          <div class="field"><label>SSH password</label><input id="j-pass" type="password" /></div>
          <div class="field">
            <label>Method</label>
            <select id="j-method">
              <option value="dd">Full Disk (dd)</option>
              <option value="rsync">Files (rsync)</option>
              <option value="zfs">ZFS Snapshot</option>
            </select>
          </div>
          <div class="field" id="j-disk-wrap"><label>Disk device</label><input id="j-disk" value="/dev/sda" /></div>
          <div class="field hide" id="j-files-wrap"><label>Paths (comma separated)</label><input id="j-files" value="/etc" /></div>
          <div class="field hide" id="j-zfs-wrap"><label>ZFS dataset</label><input id="j-zfs" /></div>
          <div class="field"><label>Store to</label><input id="j-store" value="/backup" /></div>
          <div class="field"><label>Cloud (rclone)</label><input id="j-cloud" /></div>
          <div class="field"><label>Cron schedule <span class="hint">e.g. 0 2 * * *</span></label><input id="j-sched" value="0 2 * * *" /></div>
        </div>

        <div class="actions">
          <button id="btn-add-job" class="btn">Add/Update job</button>
          <button id="btn-apply" class="btn btn--primary">Apply schedule</button>
        </div>

        <div class="log-wrap">
          <div class="log-title">Jobs</div>
          <pre id="jobs-log" class="log"></pre>
        </div>
      </section>

      <!-- MOUNTS -->
      <section id="mounts" class="panel" role="tabpanel" aria-labelledby="Mounts">
        <p class="help">
          Add storage locations. <strong>CIFS/SMB:</strong> Windows-style network share. <strong>NFS:</strong> Unix/Linux export.
        </p>
        <div class="form">
          <div class="field">
            <label>Protocol</label>
            <select id="m-proto"><option value="cifs">CIFS/SMB</option><option value="nfs">NFS</option></select>
          </div>
          <div class="field"><label>Server <span class="hint">IP or hostname</span></label><input id="m-server" placeholder="192.168.1.10" /></div>
          <div class="field"><label>Share/Export <span class="hint">CIFS: share name · NFS: export path</span></label><input id="m-share" placeholder="backups or /export/backups" /></div>
          <div class="field"><label>Mount path <span class="hint">Inside add-on</span></label><input id="m-mount" placeholder="/mnt/nas/backups" /></div>
          <div class="field"><label>Username (CIFS)</label><input id="m-user" /></div>
          <div class="field"><label>Password (CIFS)</label><input id="m-pass" type="password" /></div>
          <div class="field"><label>Options</label><input id="m-opts" placeholder="vers=3.0" /></div>
        </div>
        <div class="actions">
          <button id="btn-add-mount" class="btn">Add/Update mount</button>
        </div>
        <div class="log-wrap">
          <div class="log-title">Configured mounts</div>
          <pre id="mounts-log" class="log"></pre>
        </div>
      </section>

      <!-- HOSTS -->
      <section id="hosts" class="panel" role="tabpanel" aria-labelledby="Hosts">
        <p class="help">Save servers you use often. Apply a preset to quickly fill forms.</p>
        <div class="form">
          <div class="field"><label>Label</label><input id="h-label" placeholder="Proxmox" /></div>
          <div class="field"><label>Host/IP</label><input id="h-host" placeholder="10.0.0.21" /></div>
          <div class="field"><label>SSH user</label><input id="h-user" value="root" /></div>
          <div class="field"><label>SSH password</label><input id="h-pass" type="password" /></div>
          <div class="field"><label>Default store</label><input id="h-store" value="/backup" /></div>
          <div class="field"><label>Default disk</label><input id="h-disk" value="/dev/sda" /></div>
          <div class="field"><label>Default files</label><input id="h-files" value="/etc" /></div>
        </div>
        <div class="actions">
          <button id="btn-add-host" class="btn">Add/Update host</button>
          <button id="btn-apply-host" class="btn">Apply to forms</button>
        </div>
        <div class="log-wrap">
          <div class="log-title">Presets</div>
          <pre id="hosts-log" class="log"></pre>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="panel" role="tabpanel" aria-labelledby="Settings">
        <div class="form">
          <div class="field"><label>UI Port <span class="hint">Non-Ingress port</span></label><input id="s-port" value="8066" /></div>
          <div class="field"><label>Gotify URL <span class="hint">http://host:port</span></label><input id="s-gurl" /></div>
          <div class="field"><label>Gotify Token</label><input id="s-gtok" /></div>
          <div class="field"><label>Dropbox enabled</label>
            <select id="s-dbxe"><option value="false" selected>false</option><option value="true">true</option></select>
          </div>
          <div class="field"><label>Dropbox remote <span class="hint">e.g. dropbox:HA-Backups</span></label><input id="s-dbxr" value="dropbox:HA-Backups" /></div>
        </div>

        <div class="actions">
          <button id="btn-save" class="btn btn--primary">Save settings</button>
          <button id="btn-list" class="btn">List local backups</button>
        </div>

        <div class="log-wrap">
          <div class="log-title">Status</div>
          <pre id="settings-log" class="log"></pre>
        </div>
      </section>
    </div>
  </div>

  <script>
    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('is-active'));
        btn.classList.add('is-active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('is-active'));
        document.getElementById(btn.dataset.tab).classList.add('is-active');
      });
    });

    const $ = s => document.querySelector(s);
    const show = (el, v) => el.classList.toggle('hide', !v);

    async function POST(url, body) {
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{})});
      return r.json().catch(()=>({}));
    }
    async function GET(url) {
      const r = await fetch(url);
      return r.json().catch(()=>({}));
    }

    // Form toggles
    function bindToggles(prefix){
      $('#'+prefix+'-method').addEventListener('change', e=>{
        const m=e.target.value;
        show($('#'+prefix+'-disk-wrap'), m==='dd');
        show($('#'+prefix+'-files-wrap'), m==='rsync');
        if (prefix==='b' || prefix==='j') show($('#'+prefix+'-zfs-wrap'), m==='zfs');
        if (prefix==='r') { show($('#r-image-wrap'), m==='dd'); show($('#r-disk-wrap'), m==='dd'); show($('#r-src-wrap'), m==='rsync'); show($('#r-dest-wrap'), m==='rsync'); }
      });
    }
    bindToggles('b'); bindToggles('r'); bindToggles('j');

    // Load & save options
    let OPTIONS = {};
    async function loadOptions(){
      OPTIONS = await GET('api/options') || {};
      // Settings
      $('#s-port').value = OPTIONS.ui_port||8066;
      $('#s-gurl').value = OPTIONS.gotify_url||'';
      $('#s-gtok').value = OPTIONS.gotify_token||'';
      $('#s-dbxe').value = String(!!OPTIONS.dropbox_enabled);
      $('#s-dbxr').value = OPTIONS.dropbox_remote||'dropbox:HA-Backups';
      // Hosts
      const hosts = OPTIONS.known_hosts||[];
      $('#hosts-log').textContent = hosts.map(h=>`${h.label||''} — ${h.host||''} (${h.username||'root'})`).join('\n');
      const preset = $('#b-preset'); preset.innerHTML='<option value="">—</option>'+(hosts.map((h,i)=>`<option value="${i}">${h.label||h.host}</option>`).join(''));
      // Mounts
      const ms = OPTIONS.nas_mounts||[];
      $('#mounts-log').textContent = ms.join('\n');
      // Jobs (display only)
      $('#jobs-log').textContent = (OPTIONS.jobs||[]).join('\n');
    }
    loadOptions();

    // Apply host preset to Backup form
    $('#b-preset').addEventListener('change', e=>{
      const idx = parseInt(e.target.value,10);
      const h = (OPTIONS.known_hosts||[])[idx];
      if (!h) return;
      $('#b-host').value = h.host||'';
      $('#b-user').value = h.username||'root';
      $('#b-pass').value = h.password||'';
      $('#b-disk').value = h.disk||'/dev/sda';
      $('#b-files').value = h.files||'/etc';
      $('#b-store').value = h.store_to||'/backup';
    });

    // Backup actions
    $('#btn-probe').onclick = async ()=>{
      const payload={host:$('#b-host').value,username:$('#b-user').value,password:$('#b-pass').value};
      const j=await POST('api/probe_host', payload);
      $('#backup-log').textContent = j.out || JSON.stringify(j,null,2);
    };
    $('#btn-tools').onclick = async ()=>{
      const payload={host:$('#b-host').value,username:$('#b-user').value,password:$('#b-pass').value};
      const j=await POST('api/install_tools', payload);
      $('#backup-log').textContent = j.out || JSON.stringify(j,null,2);
    };
    $('#btn-backup').onclick = async ()=>{
      const p={method:$('#b-method').value,host:$('#b-host').value,username:$('#b-user').value,password:$('#b-pass').value,
               store_to:$('#b-store').value,cloud_upload:$('#b-cloud').value,
               disk:$('#b-disk').value,files:$('#b-files').value,zfs_dataset:$('#b-zfs').value};
      const j=await POST('api/run_backup', p);
      $('#backup-log').textContent = JSON.stringify(j,null,2);
    };

    // Restore
    $('#btn-run-restore').onclick = async ()=>{
      const p={method:$('#r-method').value,host:$('#r-host').value,username:$('#r-user').value,password:$('#r-pass').value,
               image_path:$('#r-image').value,disk:$('#r-disk').value,
               local_src:$('#r-src').value,remote_dest:$('#r-dest').value};
      const j=await POST('api/run_restore', p);
      $('#restore-log').textContent = JSON.stringify(j,null,2);
    };

    // Settings save
    $('#btn-save').onclick = async ()=>{
      const p={ui_port:parseInt($('#s-port').value||'8066',10),
               gotify_enabled:!!($('#s-gurl').value && $('#s-gtok').value),
               gotify_url:$('#s-gurl').value, gotify_token:$('#s-gtok').value,
               dropbox_enabled:($('#s-dbxe').value==='true'),
               dropbox_remote:$('#s-dbxr').value};
      const opts = Object.assign({}, OPTIONS, p);
      const j=await POST('api/options', opts);
      $('#settings-log').textContent = j.ok ? 'Saved.' : JSON.stringify(j);
      loadOptions();
    };

    // Jobs
    function jobFromForm(){
      const m=$('#j-method').value;
      const j={
        name: $('#j-name').value, host: $('#j-host').value, username: $('#j-user').value, password: $('#j-pass').value,
        method: m, disk: $('#j-disk').value, files: $('#j-files').value, zfs_dataset: $('#j-zfs').value,
        store_to: $('#j-store').value, cloud_upload: $('#j-cloud').value, schedule: $('#j-sched').value
      };
      return j;
    }
    function addOrUpdateJob(){
      const j = jobFromForm();
      const arr = OPTIONS.jobs || [];
      const idx = arr.findIndex(x=>{ try{ const o=JSON.parse(x); return o.name && o.name===j.name; }catch(e){ return false; } });
      const line = JSON.stringify(j);
      if (idx>=0) arr[idx]=line; else arr.push(line);
      OPTIONS.jobs = arr;
    }
    $('#btn-add-job').onclick = async ()=>{
      addOrUpdateJob();
      const res = await POST('api/options', OPTIONS);
      $('#jobs-log').textContent = res.ok ? (OPTIONS.jobs||[]).join('\n') : JSON.stringify(res);
    };
    $('#btn-apply').onclick = async ()=>{
      const j=await POST('api/apply_schedule');
      $('#jobs-log').textContent = j.out || JSON.stringify(j,null,2);
    };

    // Mounts
    function mountLine(){
      const proto=$('#m-proto').value, server=$('#m-server').value, share=$('#m-share').value, mount=$('#m-mount').value;
      const user=$('#m-user').value, pass=$('#m-pass').value, opts=$('#m-opts').value;
      let line = `proto=${proto};server=${server};share=${share};mount=${mount}`;
      if (user) line+=`;username=${user}`;
      if (pass) line+=`;password=${pass}`;
      if (opts) line+=`;options=${opts}`;
      return line;
    }
    $('#btn-add-mount').onclick = async ()=>{
      const line = mountLine();
      const arr = OPTIONS.nas_mounts || [];
      const key = line.replace(/;password=[^;]*/,''); // dedupe ignoring pw
      const idx = arr.findIndex(s=>s && s.replace(/;password=[^;]*/,'')===key);
      if (idx>=0) arr[idx]=line; else arr.push(line);
      OPTIONS.nas_mounts = arr;
      const res = await POST('api/options', OPTIONS);
      $('#mounts-log').textContent = (OPTIONS.nas_mounts||[]).join('\n');
    };

    // Known hosts
    function hostFromForm(){
      return {
        label: $('#h-label').value, host: $('#h-host').value, username: $('#h-user').value, password: $('#h-pass').value,
        store_to: $('#h-store').value, disk: $('#h-disk').value, files: $('#h-files').value
      };
    }
    $('#btn-add-host').onclick = async ()=>{
      const h = hostFromForm();
      const arr = OPTIONS.known_hosts || [];
      const idx = arr.findIndex(x=> (x.label && x.label===h.label) || (x.host && x.host===h.host));
      if (idx>=0) arr[idx]=h; else arr.push(h);
      OPTIONS.known_hosts = arr;
      const res = await POST('api/options', OPTIONS);
      $('#hosts-log').textContent = arr.map(h=>`${h.label||''} — ${h.host||''} (${h.username||'root'})`).join('\n');
      const preset = $('#b-preset'); preset.innerHTML='<option value="">—</option>'+(arr.map((h,i)=>`<option value="${i}">${h.label||h.host}</option>`).join(''));
    };
    $('#btn-apply-host').onclick = ()=>{
      const h = hostFromForm();
      $('#b-host').value = h.host||'';
      $('#b-user').value = h.username||'root';
      $('#b-pass').value = h.password||'';
      $('#b-disk').value = h.disk||'/dev/sda';
      $('#b-files').value = h.files||'/etc';
      $('#b-store').value = h.store_to||'/backup';
    };
  </script>
</body>
</html>
