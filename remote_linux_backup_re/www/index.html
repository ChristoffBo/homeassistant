<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Remote Linux Backup</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg:#0b0f14; --panel:#0f1720; --text:#eaf2f8; --muted:#b6c5d6;
  --border:#223245; --accent:#0ea5e9; --accent-2:#7c5cff; --danger:#ef4444;
  --radius:16px; --shadow:0 14px 38px rgba(0,0,0,.40);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
.page{min-height:100%;display:grid;place-items:start center;padding:32px 12px}
.card{width:100%;max-width:1100px;background:linear-gradient(180deg,#101a27 0%, #0c141f 100%);
  border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
.card__header{display:flex;gap:14px;align-items:center;margin-bottom:12px}
.brand__logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#7c5cff,#3dc8ff)}
.brand__title{margin:0;font-weight:800;letter-spacing:.3px;font-size:1.35rem}
.brand__subtitle{margin:2px 0 0;color:var(--muted);font-size:.95rem}
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px}
.tab{background:#121e2c;border:1px solid var(--border);color:#ddecff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}
.tab.is-active{background:#1a2b3f;border-color:#33506f}
.notice{margin-bottom:12px;padding:10px 12px;border-radius:10px;background:#0e1522;border:1px solid var(--border);color:#cfe0ff}
.panel{display:none;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
.panel.is-active{display:block}
.form{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px}
@media (max-width:860px){ .form{grid-template-columns:1fr} }
.field label{display:grid;gap:6px;font-weight:800}
.field--wide{grid-column:1/-1}
.inline{display:grid;grid-template-columns:1fr auto;gap:8px}
input,select,textarea{background:#0e1724;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px;outline:none}
input::placeholder{color:#8ba2b9}
input:focus,select:focus,textarea:focus{border-color:#3a5a78;box-shadow:0 0 0 3px rgba(14,165,233,.18)}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.actions.compact{margin-top:6px}
.btn{background:#17263a;border:1px solid var(--border);color:#e6f1ff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
.btn:hover{filter:brightness(1.06)}
.btn--primary{background:var(--accent);color:#03131e;border-color:transparent}
.btn--danger{background:var(--danger);color:#fff;border-color:transparent}
.btn--ghost{background:transparent;border-color:var(--border);color:#ddecff}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:middle}
.table .actions-col{width:260px}
.log{background:#0a121b;border:1px solid var(--border);border-radius:10px;padding:12px;min-height:140px;white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.95rem;margin-top:10px}
.hint{color:var(--muted);font-size:.92rem;font-weight:600}
.table-title{margin:14px 0 4px}
.details{margin-top:10px}
.details summary{cursor:pointer;font-weight:800}
.code{background:#0b1522;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:20}
.modal[aria-hidden="false"]{display:flex}
.modal__panel{background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:14px;max-width:900px;width:96%;max-height:80vh;display:grid;grid-template-rows:auto auto 1fr auto;gap:8px}
.modal__header{display:flex;justify-content:space-between;align-items:center}
.list{border:1px solid var(--border);border-radius:8px;overflow:auto}
.list .row{display:flex;gap:10px;padding:8px;border-bottom:1px dashed #223049;cursor:pointer}
.list .row:hover{background:#131c2a}
.list .type{opacity:.7;width:90px}
.notice-inline{background:#0b1522;border:1px dashed var(--border);border-radius:10px;padding:8px;margin-top:6px;color:#cfe0ff}
</style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="card__header">
        <div class="brand__logo" aria-hidden="true"></div>
        <div>
          <h1 class="brand__title">Remote Linux Backup</h1>
          <p class="brand__subtitle">Simple backups & mounts</p>
        </div>
      </div>

      <nav class="tabs">
        <button class="tab is-active" data-target="backup">Backup</button>
        <button class="tab" data-target="restore">Restore</button>
        <button class="tab" data-target="mounts">Mounts</button>
        <button class="tab" data-target="backups">Backups</button>
        <button class="tab" data-target="schedule">Schedule</button>
        <button class="tab" data-target="settings">Settings</button>
        <button class="tab" data-target="help">Help</button>
      </nav>

      <div class="notice">
        Alpha software. Use at your own risk. <b>Restores can destroy data.</b> Always have verified backups.
      </div>

      <!-- BACKUP -->
      <section id="panel-backup" class="panel is-active">
        <form class="form" onsubmit="return false;">
          <div class="field"><label>Host/IP <input id="b_host" placeholder="10.0.0.10"></label></div>
          <div class="field"><label>User <input id="b_user" value="root"></label></div>
          <div class="field"><label>Port <input id="b_port" value="22"></label></div>
          <div class="field"><label>Password <input id="b_pass" type="password"></label></div>
          <div class="field"><label>Method
            <select id="b_method">
              <option value="dd">Full Disk (dd)</option>
              <option value="rsync">Files (rsync over SSH)</option>
              <option value="zfs">ZFS snapshot</option>
            </select></label></div>
          <div class="field" data-show="dd"><label>Disk device (dd) <input id="b_disk" value="/dev/sda"></label></div>

          <div class="field field--wide" data-show="rsync">
            <label>Rsync source (remote path or comma-separated list)
              <div class="inline">
                <input id="b_files" placeholder="/etc,/var/www or /home/user" />
                <button class="btn" id="btn_browse_remote">Browse remote…</button>
              </div>
              <span class="hint">Uses SSH to list folders on the remote. If not supported yet, just type the paths.</span>
            </label>
          </div>

          <div class="field field--wide">
            <label>Store to (local folder or mounted share)
              <select id="b_store"></select>
            </label>
            <div class="actions compact">
              <button class="btn" id="btn_store_mount">Mount</button>
              <button class="btn" id="btn_store_unmount">Unmount</button>
              <span id="b_store_status" class="hint"></span>
            </div>
          </div>

          <div class="field" data-show="rsync"><label>Excludes (rsync, comma separated)
            <input id="b_excludes" placeholder="*.tmp,*.cache"></label></div>
          <div class="field"><label>Bandwidth limit (KB/s) <input id="b_bw" placeholder=""></label></div>
          <div class="field" data-show="dd"><label>Verify (dd)
            <select id="b_verify"><option value="false">No</option><option value="true">Yes</option></select></label></div>
          <div class="field"><label>Retention days (prune old) <input id="b_retention" placeholder=""></label></div>
          <div class="field field--wide"><label>Cloud upload (rclone remote:path)
            <input id="b_cloud" placeholder="dropbox:HA-Backups"></label></div>
          <div class="field"><label>Backup name (label) <input id="b_name" placeholder="OPNsense-01"></label></div>
        </form>
        <div class="actions">
          <button class="btn" id="btnEstimate">Estimate</button>
          <button class="btn btn--primary" id="btnBackup">Run Backup</button>
        </div>
      </section>

      <!-- RESTORE -->
      <section id="panel-restore" class="panel">
        <form class="form" onsubmit="return false;">
          <div class="field"><label>Host/IP <input id="r_host" placeholder="10.0.0.10"></label></div>
          <div class="field"><label>User <input id="r_user" value="root"></label></div>
          <div class="field"><label>Port <input id="r_port" value="22"></label></div>
          <div class="field"><label>Password <input id="r_pass" type="password"></label></div>
          <div class="field"><label>Method
            <select id="r_method">
              <option value="dd">Full Disk (dd)</option>
              <option value="rsync">Files (rsync)</option>
            </select></label></div>
          <div class="field" data-show="dd"><label>Disk device (dd) <input id="r_disk" value="/dev/sda"></label></div>
          <div class="field field--wide"><label>Image path (dd) or local source (rsync)
            <div class="inline">
              <input id="r_image" placeholder="/backup/myhost-2025-01-01.img.gz">
              <button class="btn" id="btn_browse_local">Pick from backups…</button>
            </div>
            <span class="hint">Use Backups → “Use for restore”, or click here.</span>
          </label></div>
          <div class="field" data-show="rsync"><label>Remote dest (rsync) <input id="r_dest" value="/"></label></div>
          <div class="field" data-show="rsync"><label>Excludes (rsync) <input id="r_ex" placeholder="*.tmp,*.cache"></label></div>
          <div class="field"><label>Bandwidth limit (KB/s) <input id="r_bw" placeholder=""></label></div>
        </form>
        <div class="actions">
          <button class="btn btn--danger" id="btnRestore">Restore (double confirm)</button>
        </div>
      </section>

      <!-- MOUNTS -->
      <section id="panel-mounts" class="panel">
        <form class="form" onsubmit="return false;">
          <div class="field"><label>Preset name <input id="m_name" placeholder="NAS-Backups"></label></div>
          <div class="field"><label>Protocol
            <select id="m_proto"><option value="cifs">SMB/CIFS</option><option value="nfs">NFS</option></select></label></div>
          <div class="field"><label>Server / host <input id="m_server" placeholder="10.0.0.21"></label></div>
          <div class="field"><label>Username (SMB) <input id="m_user" placeholder="user"></label></div>
          <div class="field"><label>Password (SMB) <input id="m_pass" type="password" placeholder="password"></label></div>
          <div class="field field--wide">
            <label>Share (SMB: name/subdir) or Export (NFS: /path)
              <div class="inline">
                <select id="m_share_select"></select>
                <input id="m_share" placeholder="Backups or Backups/subdir or /export/backups">
              </div>
              <span class="hint">Click “List shares/exports” then “Browse” for subfolders; “Select this folder” fills the field.</span>
            </label>
          </div>
          <div class="field"><label>Mount point <input id="m_mount" value="/mnt/Backups"></label></div>
          <div class="field"><label>Extra options <input id="m_opts" placeholder="iocharset=utf8,uid=0,gid=0"></label></div>
          <div class="field"><label>Auto-mount on start
            <select id="m_auto"><option value="false">No</option><option value="true">Yes</option></select></label></div>
        </form>
        <div class="actions">
          <button class="btn" id="btnList">List shares/exports</button>
          <button class="btn" id="btnBrowse">Browse</button>
          <button class="btn btn--primary" id="btnAddMount">Add / Update</button>
        </div>

        <h3 class="table-title">Mount presets</h3>
        <table class="table">
          <thead><tr><th>Name</th><th>Proto</th><th>Server</th><th>Share/Export</th><th>Mount</th><th>Auto</th><th>Actions</th></tr></thead>
          <tbody id="mountTable"></tbody>
        </table>
      </section>

      <!-- BACKUPS -->
      <section id="panel-backups" class="panel">
        <table class="table">
          <thead>
            <tr>
              <th>Path</th><th>Type</th><th>Location</th><th>Size</th><th>Date</th><th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody id="backups_rows"></tbody>
        </table>
      </section>

      <!-- SCHEDULE -->
      <section id="panel-schedule" class="panel">
        <form class="form" onsubmit="return false;">
          <div class="field field--wide"><label>Job name <input id="sch_name" placeholder="Nightly-OPNsense" /></label></div>
          <div class="field"><label>CRON (min hour dom mon dow)
            <input id="sch_cron" placeholder="0 2 * * *"><span class="hint">Examples: 0 2 * * * (02:00 daily), 0 */6 * * * (every 6h)</span></label></div>
          <div class="field"><label>Method
            <select id="sch_method"><option value="dd">dd</option><option value="rsync">rsync</option><option value="zfs">zfs</option></select></label></div>
          <div class="field"><label>Host/IP <input id="sch_host" placeholder="10.0.0.10"></label></div>
          <div class="field"><label>User <input id="sch_user" value="root"></label></div>
          <div class="field"><label>Port <input id="sch_port" value="22"></label></div>
          <div class="field"><label>Password <input id="sch_pass" type="password"></label></div>
          <div class="field"><label>Disk / Rsync source <input id="sch_source" placeholder="/dev/sda or /etc,/home"></label></div>
          <div class="field"><label>Store to <input id="sch_store" placeholder="/backup or /mnt/NAS"></label></div>
        </form>
        <div class="actions">
          <button class="btn btn--primary" id="btnSchAdd">Add / Update Schedule</button>
          <button class="btn" id="btnSchRefresh">Refresh</button>
        </div>
        <table class="table">
          <thead><tr><th>Name</th><th>Cron</th><th>Method</th><th>Host</th><th>Source</th><th>Store</th><th>Actions</th></tr></thead>
          <tbody id="sch_rows"></tbody>
        </table>
        <div class="hint" id="sch_hint"></div>
      </section>

      <!-- SETTINGS -->
      <section id="panel-settings" class="panel">
        <form class="form" onsubmit="return false;">
          <div class="field"><label>Gotify URL (e.g. https://gotify.your.tld) <input id="s_gurl"></label></div>
          <div class="field"><label>Gotify token <input id="s_gtoken"></label></div>
          <div class="field"><label>Enable Gotify
            <select id="s_gen"><option value="false">No</option><option value="true">Yes</option></select></label></div>
          <div class="field"><label>Dropbox remote (rclone) <input id="s_dropremote" value="dropbox:HA-Backups"></label></div>
          <div class="field"><label>Enable Dropbox
            <select id="s_dben"><option value="false">No</option><option value="true">Yes</option></select></label></div>
          <div class="field"><label>UI Port <input id="s_uiport" value="8066"></label></div>
        </form>
        <div class="actions">
          <button class="btn btn--primary" id="btnSaveSettings">Save Settings</button>
          <button class="btn" id="btnTestGotify">Test Gotify</button>
        </div>
        <textarea id="status_box" class="log" placeholder="Status / Output"></textarea>
      </section>

      <!-- HELP -->
      <section id="panel-help" class="panel">
        <h3>How to use</h3>
        <details class="details" open>
          <summary>Quick start</summary>
          <div class="code">
            1) Go to <b>Mounts</b>, click “List shares/exports” or “Browse”, then “Select this folder”, “Add / Update” and “Mount”.<br/>
            2) In <b>Backup</b>, set Host/IP & credentials, choose a method:<br/>
            &nbsp;• <b>dd</b> full disk image (fast restore, big files).<br/>
            &nbsp;• <b>rsync</b> selected folders (uses SSH). Click “Browse remote” to pick folders.<br/>
            3) Pick “Store to” (your mounted path or /backup). Run backup. Gotify notifies on success/fail.<br/>
            4) Restore from <b>Backups</b> (“Use for restore” asks for target) or from the Restore tab.
          </div>
        </details>
        <details class="details"><summary>Restore from USB</summary>
          <div class="notice-inline">Mount the USB into the add-on. If it’s under /backup or /mnt/… it will appear in Backups. Click “Use for restore”.</div>
        </details>
        <details class="details"><summary>SMB/NFS</summary>
          <div>Use <b>List</b> to get shares/exports; <b>Browse</b> to pick subfolders; “Select this folder” fills the <i>Share</i> field (SMB: <code>SHARE/subdir</code>).</div>
        </details>
        <details class="details"><summary>Schedules</summary>
          <div>Standard CRON. Jobs run the same backup engine; Gotify sends notifications when enabled.</div>
        </details>
      </section>
    </div>
  </div>

  <!-- BROWSE MODAL -->
  <div id="browse_modal" class="modal" aria-hidden="true">
    <div class="modal__panel">
      <div class="modal__header">
        <strong id="browse_title">Browse</strong>
        <button class="btn btn--ghost" id="browse_close">Close</button>
      </div>
      <div class="muted" id="browse_path"></div>
      <div class="list" id="browse_list"></div>
      <div class="actions">
        <button class="btn" id="browse_up">Up</button>
        <button class="btn btn--primary" id="browse_select">Select this folder</button>
      </div>
    </div>
  </div>

  <!-- RESTORE TARGET MODAL -->
  <div id="restore_modal" class="modal" aria-hidden="true">
    <div class="modal__panel" style="grid-template-rows:auto 1fr auto;">
      <div class="modal__header">
        <strong>Restore Target</strong>
        <button class="btn btn--ghost" id="restore_close">Close</button>
      </div>
      <div>
        <div id="restore_info" class="hint" style="margin-bottom:8px"></div>
        <div id="restore_fields"></div>
      </div>
      <div class="actions">
        <button class="btn btn--danger" id="restore_go">Restore now</button>
      </div>
    </div>
  </div>

<script>
/* helpers */
async function api(path, opts={}) {
  const headers = opts.headers || {};
  if (!headers["Content-Type"] && opts.body) headers["Content-Type"] = "application/json";
  const r = await fetch(path, {...opts, headers});
  let text = await r.text();
  let json; try { json = text ? JSON.parse(text) : {}; } catch { json = {ok:false, raw:text}; }
  if (!r.ok) return Promise.resolve(json || {ok:false});
  return json || {ok:true};
}
const $ = s => document.querySelector(s);
function showTab(name){
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('is-active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('is-active'));
  document.querySelector(`.tab[data-target="${name}"]`).classList.add('is-active');
  document.getElementById(`panel-${name}`).classList.add('is-active');
}
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.target)));
function applyMethodVisibility(prefix){
  const method = document.getElementById(`${prefix}_method`).value;
  document.querySelectorAll(`#panel-${prefix} [data-show]`).forEach(el=>{
    el.style.display = (el.getAttribute('data-show')===method) ? '' : 'none';
  });
}
['b','r'].forEach(p=>{
  document.getElementById(`${p}_method`)?.addEventListener('change',()=>applyMethodVisibility(p));
  applyMethodVisibility(p);
});
function setStatus(obj){ const el=document.getElementById('status_box'); if(!el) return; el.value = (typeof obj==='string')?obj:JSON.stringify(obj,null,2); }

/* SETTINGS */
async function loadOptions(){
  const j = await api('/api/options');
  (id=>document.getElementById(id).value = j.gotify_url||"")('s_gurl');
  (id=>document.getElementById(id).value = j.gotify_token||"")('s_gtoken');
  (id=>document.getElementById(id).value = String(!!j.gotify_enabled))('s_gen');
  (id=>document.getElementById(id).value = String(!!j.dropbox_enabled))('s_dben');
  (id=>document.getElementById(id).value = j.dropbox_remote||"dropbox:HA-Backups")('s_dropremote');
  (id=>document.getElementById(id).value = j.ui_port||8066)('s_uiport');
}
document.getElementById("btnSaveSettings").onclick = async ()=>{
  const body = {
    gotify_url:document.getElementById("s_gurl").value.trim(),
    gotify_token:document.getElementById("s_gtoken").value.trim(),
    gotify_enabled:(document.getElementById("s_gen").value==="true"),
    dropbox_enabled:(document.getElementById("s_dben").value==="true"),
    dropbox_remote:document.getElementById("s_dropremote").value.trim(),
    ui_port:parseInt(document.getElementById("s_uiport").value||"8066",10)
  };
  setStatus(await api('/api/options',{method:'POST',body:JSON.stringify(body)}));
};
document.getElementById("btnTestGotify").onclick = async ()=>{
  const body = { url:document.getElementById("s_gurl").value.trim(), token:document.getElementById("s_gtoken").value.trim(), insecure:true };
  setStatus(await api('/api/gotify_test',{method:'POST',body:JSON.stringify(body)}));
};

/* MOUNTS */
let mounts = [];
async function refreshMounts(){
  const j = await api('/api/mounts');
  mounts = j.mounts || j.items || [];
  const tb = document.getElementById('mountTable'); tb.innerHTML='';
  mounts.forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${m.name||""}</td><td>${m.proto}</td><td>${m.server}</td><td>${m.share}</td>
      <td>${m.mount}</td><td>${m.auto_mount?'Yes':'No'}</td><td></td>`;
    const td = tr.lastChild;
    const btnM=document.createElement('button'); btnM.className='btn'; btnM.textContent='Mount';
    btnM.onclick=async()=>{ setStatus(await api('/api/mount_now',{method:'POST',body:JSON.stringify(m)})); refreshMounts(); fillStoreTargets(); };
    const btnU=document.createElement('button'); btnU.className='btn'; btnU.style.marginLeft='6px'; btnU.textContent='Unmount';
    btnU.onclick=async()=>{ setStatus(await api('/api/unmount_now',{method:'POST',body:JSON.stringify({mount:m.mount})})); refreshMounts(); fillStoreTargets(); };
    const btnD=document.createElement('button'); btnD.className='btn btn--danger'; btnD.style.marginLeft='6px'; btnD.textContent='Delete';
    btnD.onclick=async()=>{ setStatus(await api('/api/mount_delete',{method:'POST',body:JSON.stringify({name:m.name})})); refreshMounts(); fillStoreTargets(); };
    const btnF=document.createElement('button'); btnF.className='btn'; btnF.style.marginLeft='6px'; btnF.textContent='Fill form';
    btnF.onclick=()=>{ ['name','proto','server','username','password','share','mount','options'].forEach(k=>{
        const map={name:'m_name',proto:'m_proto',server:'m_server',username:'m_user',password:'m_pass',share:'m_share',mount:'m_mount',options:'m_opts'};
        document.getElementById(map[k]).value = (m[k]||'');
      });
      document.getElementById('m_auto').value = String(!!m.auto_mount);
    };
    td.append(btnM,btnU,btnD,btnF);
    tb.appendChild(tr);
  });
  fillStoreTargets();
}
function fillStoreTargets(){
  const sel = document.getElementById('b_store'); const current = sel.value;
  sel.innerHTML='';
  const o1=document.createElement('option'); o1.value='/backup'; o1.textContent='/backup (local)'; sel.appendChild(o1);
  mounts.forEach(m=>{ const o=document.createElement('option'); o.value=m.mount; o.textContent=`${m.name||m.mount} (${m.mount})`; sel.appendChild(o); });
  if (current) sel.value=current;
}
document.getElementById('btnAddMount').onclick = async ()=>{
  const body = {
    name:document.getElementById('m_name').value.trim(),
    proto:document.getElementById('m_proto').value,
    server:document.getElementById('m_server').value.trim(),
    username:document.getElementById('m_user').value.trim(),
    password:document.getElementById('m_pass').value,
    share:document.getElementById('m_share').value.trim(),
    mount:document.getElementById('m_mount').value.trim(),
    options:document.getElementById('m_opts').value.trim(),
    auto_mount:(document.getElementById('m_auto').value==='true')
  };
  if (!body.name || !body.server || !body.share) { alert('Name, server, share/export are required.'); return; }
  setStatus(await api('/api/mount_add_update',{method:'POST',body:JSON.stringify(body)}));
  refreshMounts();
};
document.getElementById('btnList').onclick = async ()=>{
  const server=document.getElementById('m_server').value.trim();
  if(!server){ alert('Enter server first'); return; }
  const proto=document.getElementById('m_proto').value;
  const r = await api(`/api/mount_list?proto=${encodeURIComponent(proto)}&server=${encodeURIComponent(server)}`);
  const sel=document.getElementById('m_share_select'); sel.innerHTML='';
  (r.items||[]).filter(it=>it.name||it.path).forEach(it=>{
    const o=document.createElement('option'); o.value=it.name||it.path; o.textContent=it.name||it.path; sel.appendChild(o);
  });
  setStatus(r);
};
document.getElementById('m_share_select').addEventListener('change', ()=>{
  const v=document.getElementById('m_share_select').value; if (v) document.getElementById('m_share').value=v;
});

/* Browse modal (SMB/NFS and SSH) */
const modal=document.getElementById('browse_modal');
const browsePath=document.getElementById('browse_path');
const browseList=document.getElementById('browse_list');
const browseTitle=document.getElementById('browse_title');
let browseCtx=null;
function openModal(){ modal.setAttribute('aria-hidden','false'); }
function closeModal(){ modal.setAttribute('aria-hidden','true'); browseList.innerHTML=''; browsePath.textContent=''; browseCtx=null; }
document.getElementById('browse_close').onclick=closeModal;
async function doBrowse(){
  if(!browseCtx) return;
  if(browseCtx.mode==='ssh'){
    const payload={ host:browseCtx.host, username:browseCtx.user, password:browseCtx.pass, port:browseCtx.port, path:browseCtx.path||'/' };
    const r = await api('/api/ssh_ls',{method:'POST',body:JSON.stringify(payload)});
    if(!r || r.ok===false){ browseList.innerHTML='<div class="notice-inline">Remote browse not available yet in backend. Type paths manually.</div>'; return; }
    renderList((r.items||[]).map(it=>({name:it.name,type:it.is_dir?'dir':'file'})));
    browsePath.textContent=`${browseCtx.host}:${browseCtx.path||'/'}`;
  }else{
    const body={ proto:browseCtx.mode==='smb'?'cifs':'nfs', server:browseCtx.server, username:browseCtx.user, password:browseCtx.pass,
      share:browseCtx.share, path:browseCtx.path||'' };
    const r=await api('/api/mount_browse',{method:'POST',body:JSON.stringify(body)});
    renderList(r.items||[]);
    const prefix=(browseCtx.mode==='smb'
      ? `//${browseCtx.server}/${browseCtx.share||''}/${browseCtx.path||''}`.replace(/\/+/g,'/')
      : `${browseCtx.server} ${browseCtx.share||''} ${browseCtx.path||''}`.trim());
    browsePath.textContent=prefix;
  }
}
function renderList(items){
  browseList.innerHTML='';
  items.forEach(it=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<div class="type">${(it.type||'').toUpperCase()}</div><div>${it.name||it.path||''}</div>`;
    row.onclick=async()=>{
      if(browseCtx.mode==='ssh'){ if(it.type==='dir'){ browseCtx.path=(browseCtx.path?`${browseCtx.path}/${it.name}`:it.name); await doBrowse(); } }
      else{
        if(!browseCtx.share && it.type==='share'){ document.getElementById('m_share').value=it.name; closeModal(); return; }
        if(it.type==='dir'){ browseCtx.path=(browseCtx.path?`${browseCtx.path}/${it.name}`:it.name); await doBrowse(); }
      }
    };
    browseList.appendChild(row);
  });
}
document.getElementById('browse_up').onclick=async()=>{
  if(!browseCtx) return;
  if(browseCtx.path){ const parts=browseCtx.path.replace(/\/+$/,'').split('/'); parts.pop(); browseCtx.path=parts.join('/'); await doBrowse(); }
  else if((browseCtx.mode==='smb'||browseCtx.mode==='nfs') && browseCtx.share){ browseCtx.share=''; await doBrowse(); }
};
document.getElementById('browse_select').onclick=()=>{
  if(!browseCtx) return;
  if(browseCtx.mode==='ssh'){
    const current=document.getElementById('b_files').value.trim();
    const add=(browseCtx.path?`/${browseCtx.path.replace(/^\/?/,'')}`:'/'); 
    document.getElementById('b_files').value = current ? (current+','+add) : add;
  }else{
    const sub=browseCtx.path ? `${browseCtx.share}/${browseCtx.path}` : browseCtx.share;
    if(sub) document.getElementById('m_share').value=sub;
  }
  closeModal();
};
document.getElementById('btnBrowse').onclick=()=>{
  const proto=document.getElementById('m_proto').value; const server=document.getElementById('m_server').value.trim();
  if(!server){ alert('Enter server first'); return; }
  browseCtx={ mode:(proto==='cifs'?'smb':'nfs'), server, user:document.getElementById('m_user').value, pass:document.getElementById('m_pass').value, share:document.getElementById('m_share').value.trim(), path:'' };
  browseTitle.textContent=(proto==='cifs'?'Browse SMB':'Browse NFS'); openModal(); doBrowse();
};
document.getElementById('btn_browse_remote').onclick=(e)=>{
  e.preventDefault();
  const host=document.getElementById('b_host').value.trim(); if(!host){ alert('Enter Host/IP first.'); return; }
  browseCtx={ mode:'ssh', host, user:document.getElementById('b_user').value.trim()||'root', pass:document.getElementById('b_pass').value, port:parseInt(document.getElementById('b_port').value||'22',10), path:'/' };
  browseTitle.textContent='Browse remote (SSH)'; openModal(); doBrowse();
};

/* Backups */
async function backupsRefresh(){
  const data=await api('/api/backups');
  const body=document.getElementById('backups_rows'); body.innerHTML='';
  (data.items||[]).sort((a,b)=> (b.created||0)-(a.created||0)).forEach(x=>{
    const tr=document.createElement('tr');
    const size=(x.size>=1073741824)?`${(x.size/1073741824).toFixed(1)} GB`:(x.size>=1048576)?`${(x.size/1048576).toFixed(1)} MB`:(x.size>=1024)?`${(x.size/1024).toFixed(1)} KB`:(x.size||0)+' B';
    const date=x.created?new Date(x.created*1000).toISOString().replace('T',' ').slice(0,19):(x.mtime||'');
    tr.innerHTML=`<td>${x.path}</td><td>${x.kind||x.type||'unknown'}</td><td>${x.location||'Local'}</td><td>${size}</td><td>${date}</td><td></td>`;
    const td=tr.lastChild;
    const dl=document.createElement('a'); dl.className='btn'; dl.textContent='Download'; dl.href=`/api/download?path=${encodeURIComponent(x.path)}`; dl.target='_blank';
    const use=document.createElement('button'); use.className='btn'; use.style.marginLeft='6px'; use.textContent='Use for restore';
    use.onclick=()=>openRestoreTarget(x);
    const del=document.createElement('button'); del.className='btn btn--danger'; del.style.marginLeft='6px'; del.textContent='Delete';
    del.onclick=async()=>{ if(confirm(`Delete ${x.path}?`)){ await api('/api/backups/delete',{method:'POST',body:JSON.stringify({path:x.path})}); backupsRefresh(); } };
    td.append(dl,use,del); body.appendChild(tr);
  });
}

/* Restore Target dialog */
const rmodal=document.getElementById('restore_modal');
function openR(){ rmodal.setAttribute('aria-hidden','false'); }
function closeR(){ rmodal.setAttribute('aria-hidden','true'); document.getElementById('restore_fields').innerHTML=''; }
document.getElementById('restore_close').onclick=closeR;

function openRestoreTarget(item){
  // Guess method from extension
  const guess = (/\.(img|img\.gz|dd|dd\.gz|zst)$/i.test(item.path)) ? 'dd' : 'rsync';
  document.getElementById('restore_info').innerHTML = `Selected: <b>${item.path}</b><br/>Choose where to restore to.`;
  const box=document.getElementById('restore_fields'); box.innerHTML='';
  if(guess==='dd'){
    box.innerHTML = `<label>Disk device (dd) <input id="rt_disk" value="/dev/sda"></label>
      <div class="hint">This will overwrite the disk completely.</div>`;
  }else{
    box.innerHTML = `<label>Remote destination (rsync) <input id="rt_dest" value="/"></label>
      <div class="hint">Destination path on the remote machine.</div>`;
  }
  document.getElementById('restore_go').onclick = async ()=>{
    if(!confirm('Are you sure? Restore will overwrite data.')) return;
    if(!confirm('Last warning. Proceed with restore?')) return;
    showTab('restore');
    document.getElementById('r_image').value=item.path;
    document.getElementById('r_method').value=guess;
    applyMethodVisibility('r');
    if(guess==='dd'){ document.getElementById('r_disk').value=document.getElementById('rt_disk').value; }
    else{ document.getElementById('r_dest').value=document.getElementById('rt_dest').value; }
    closeR();
  };
  openR();
}
document.getElementById('btn_browse_local').onclick=(e)=>{ e.preventDefault(); showTab('backups'); };

/* Backup/Restore actions */
document.getElementById("btnEstimate").onclick = async ()=>{
  const body = {
    method:document.getElementById("b_method").value, username:document.getElementById("b_user").value, host:document.getElementById("b_host").value,
    password:document.getElementById("b_pass").value, port:parseInt(document.getElementById("b_port").value||"22",10),
    disk:document.getElementById("b_disk").value, files:document.getElementById("b_files").value, bwlimit_kbps:parseInt(document.getElementById("b_bw").value||"0",10)
  };
  setStatus(await api("/api/estimate_backup",{method:"POST",body:JSON.stringify(body)}));
};
document.getElementById("btnBackup").onclick = async ()=>{
  const body = {
    method:document.getElementById("b_method").value, username:document.getElementById("b_user").value, host:document.getElementById("b_host").value,
    password:document.getElementById("b_pass").value, port:parseInt(document.getElementById("b_port").value||"22",10),
    disk:document.getElementById("b_disk").value, files:document.getElementById("b_files").value, store_to:document.getElementById("b_store").value,
    verify:(document.getElementById("b_verify").value==="true"), excludes:document.getElementById("b_excludes").value,
    retention_days:parseInt(document.getElementById("b_retention").value||"0",10),
    backup_name:document.getElementById("b_name").value, bwlimit_kbps:parseInt(document.getElementById("b_bw").value||"0",10),
    cloud_upload:document.getElementById("b_cloud").value.trim()
  };
  setStatus(await api("/api/run_backup",{method:"POST",body:JSON.stringify(body)}));
  backupsRefresh();
};
document.getElementById("btnRestore").onclick = async ()=>{
  if(!confirm("Are you sure you want to restore? This will overwrite data.")) return;
  if(!confirm("Last warning. Proceed with restore?")) return;
  const body = {
    method:document.getElementById("r_method").value, username:document.getElementById("r_user").value, host:document.getElementById("r_host").value,
    password:document.getElementById("r_pass").value, port:parseInt(document.getElementById("r_port").value||"22",10),
    disk:document.getElementById("r_disk").value, image_path:document.getElementById("r_image").value,
    local_src:document.getElementById("r_image").value, remote_dest:document.getElementById("r_dest").value,
    excludes:document.getElementById("r_ex").value, bwlimit_kbps:parseInt(document.getElementById("r_bw").value||"0",10)
  };
  setStatus(await api("/api/run_restore",{method:"POST",body:JSON.stringify(body)}));
};

/* Store mount/unmount shortcuts */
document.getElementById('btn_store_mount').onclick = async (e)=>{
  e.preventDefault();
  const m=mounts.find(x=>x.mount===document.getElementById('b_store').value);
  if(!m){ document.getElementById('b_store_status').textContent='Not a preset'; return; }
  const r=await api('/api/mount_now',{method:'POST',body:JSON.stringify(m)}); document.getElementById('b_store_status').textContent=r.ok?'Mounted':'Failed';
  refreshMounts();
};
document.getElementById('btn_store_unmount').onclick = async (e)=>{
  e.preventDefault();
  const path=document.getElementById('b_store').value;
  const r=await api('/api/unmount_now',{method:'POST',body:JSON.stringify({mount:path})}); document.getElementById('b_store_status').textContent=r.ok?'Unmounted':'Failed';
  refreshMounts();
};

/* Scheduler */
async function schRefresh(){
  const r=await api('/api/schedules'); const hint=document.getElementById('sch_hint'); const body=document.getElementById('sch_rows'); body.innerHTML='';
  if(!r || r.error || (!r.items && !Array.isArray(r))){ hint.textContent="Scheduler endpoints not found (implement /api/schedules, /api/schedule_add, /api/schedule_delete, /api/schedule_run_now)."; return; }
  hint.textContent=""; (r.items||r).forEach(j=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${j.name||''}</td><td>${j.cron||''}</td><td>${j.method||''}</td><td>${j.host||''}</td><td>${j.source||''}</td><td>${j.store||''}</td><td></td>`;
    const td=tr.lastChild;
    const btnRun=document.createElement('button'); btnRun.className='btn'; btnRun.textContent='Run now';
    btnRun.onclick=async()=>{ await api('/api/schedule_run_now',{method:'POST',body:JSON.stringify({name:j.name})}); };
    const btnDel=document.createElement('button'); btnDel.className='btn btn--danger'; btnDel.style.marginLeft='6px'; btnDel.textContent='Delete';
    btnDel.onclick=async()=>{ await api('/api/schedule_delete',{method:'POST',body:JSON.stringify({name:j.name})}); schRefresh(); };
    td.append(btnRun,btnDel); body.appendChild(tr);
  });
}
document.getElementById('btnSchRefresh').onclick=schRefresh;
document.getElementById('btnSchAdd').onclick=async()=>{
  const body={ name:document.getElementById('sch_name').value.trim(), cron:document.getElementById('sch_cron').value.trim(), method:document.getElementById('sch_method').value,
    host:document.getElementById('sch_host').value.trim(), username:document.getElementById('sch_user').value.trim(), port:parseInt(document.getElementById('sch_port').value||'22',10),
    password:document.getElementById('sch_pass').value, source:document.getElementById('sch_source').value.trim(), store:document.getElementById('sch_store').value.trim() };
  if(!body.name || !body.cron){ alert('Name and CRON are required.'); return; }
  setStatus(await api('/api/schedule_add',{method:'POST',body:JSON.stringify(body)})); schRefresh();
};

/* init */
(async function init(){
  await loadOptions();
  await refreshMounts();
  await backupsRefresh();
  applyMethodVisibility('b'); applyMethodVisibility('r');
})();
</script>
</body>
</html>
