<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEIL // STEALTH DNS/DHCP</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        :root{
            --bg-dark:#0a0e14;--bg-panel:#0f1419;
            --accent-cyan:#00fff2;--accent-purple:#b388ff;
            --accent-red:#ff4444;--accent-green:#00ff88;
            --accent-yellow:#ffeb3b;--grid-color:rgba(0,255,242,0.1);
            --text-primary:#e0e0e0;--text-secondary:#888;
        }
        body{font-family:'Share Tech Mono',monospace;background:var(--bg-dark);color:var(--text-primary);overflow-x:hidden;position:relative;}
        body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(var(--grid-color) 1px,transparent 1px),linear-gradient(90deg,var(--grid-color) 1px,transparent 1px);background-size:50px 50px;animation:gridScroll 20s linear infinite;pointer-events:none;z-index:0;}
        @keyframes gridScroll{0%{transform:translate(0,0)}100%{transform:translate(50px,50px)}}
        .container{position:relative;z-index:1;max-width:1800px;margin:0 auto;padding:20px;}
        header{display:flex;justify-content:space-between;align-items:center;padding:20px 30px;background:var(--bg-panel);border:1px solid var(--accent-cyan);border-radius:4px;margin-bottom:30px;box-shadow:0 0 30px rgba(0,255,242,.3);position:relative;overflow:hidden;}
        header::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,255,242,.1),transparent);animation:headerShimmer 3s infinite;}
        @keyframes headerShimmer{0%{left:-100%}100%{left:100%}}
        .logo{display:flex;align-items:center;gap:15px;}
        .logo-icon{font-size:36px;color:var(--accent-cyan);text-shadow:0 0 20px var(--accent-cyan);}
        .logo-text h1{font-size:28px;color:var(--accent-cyan);letter-spacing:4px;text-shadow:0 0 20px var(--accent-cyan);}
        .logo-text p{font-size:11px;color:var(--text-secondary);letter-spacing:2px;}
        .status-indicator{display:flex;gap:20px;align-items:center;}
        .status-item{display:flex;flex-direction:column;align-items:center;gap:5px;}
        .status-dot{width:12px;height:12px;border-radius:50%;animation:pulse 2s infinite;}
        .status-dot.active{background:var(--accent-green);box-shadow:0 0 20px var(--accent-green);}
        .status-dot.inactive{background:var(--accent-red);box-shadow:0 0 20px var(--accent-red);}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .grid-layout{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin-bottom:30px;}
        .panel{background:var(--bg-panel);border:1px solid var(--accent-cyan);border-radius:4px;padding:20px;position:relative;overflow:hidden;box-shadow:0 0 20px rgba(0,255,242,.2);}
        .panel::before{content:'';position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--accent-cyan),transparent);animation:panelGlow 2s infinite;}
        @keyframes panelGlow{0%,100%{opacity:.3}50%{opacity:1}}
        .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--grid-color);}
        .panel-title{font-size:14px;color:var(--accent-cyan);letter-spacing:2px;text-transform:uppercase;}
        .panel-icon{font-size:18px;color:var(--accent-purple);}
        .gauge-container{display:flex;justify-content:center;align-items:center;padding:20px 0;}
        .gauge{position:relative;width:200px;height:200px;}
        .gauge svg{transform:rotate(-90deg);}
        .gauge-bg{fill:none;stroke:rgba(255,255,255,.1);stroke-width:15;}
        .gauge-fill{fill:none;stroke:var(--accent-cyan);stroke-width:15;stroke-linecap:round;transition:stroke-dashoffset .5s ease;filter:drop-shadow(0 0 10px var(--accent-cyan));}
        .gauge-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
        .gauge-value{font-size:36px;color:var(--accent-cyan);font-weight:bold;text-shadow:0 0 20px var(--accent-cyan);}
        .gauge-label{font-size:11px;color:var(--text-secondary);letter-spacing:1px;text-transform:uppercase;}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;}
        .stat-item{background:rgba(0,255,242,.05);padding:15px;border-radius:4px;border:1px solid var(--grid-color);transition:all .3s ease;}
        .stat-item:hover{border-color:var(--accent-cyan);box-shadow:0 0 15px rgba(0,255,242,.3);}
        .stat-label{font-size:11px;color:var(--text-secondary);margin-bottom:5px;text-transform:uppercase;letter-spacing:1px;}
        .stat-value{font-size:24px;color:var(--accent-cyan);font-weight:bold;}
        .stat-unit{font-size:12px;color:var(--text-secondary);margin-left:5px;}
        .progress-bar{background:rgba(255,255,255,.05);height:8px;border-radius:4px;overflow:hidden;margin-top:10px;position:relative;}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-purple));transition:width .5s ease;box-shadow:0 0 10px var(--accent-cyan);}
        .list-container{max-height:300px;overflow-y:auto;}
        .list-container::-webkit-scrollbar{width:8px;}
        .list-container::-webkit-scrollbar-track{background:rgba(255,255,255,.05);}
        .list-container::-webkit-scrollbar-thumb{background:var(--accent-cyan);border-radius:4px;}
        .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(0,255,242,.05);border:1px solid var(--grid-color);border-radius:4px;margin-bottom:8px;transition:all .3s ease;}
        .list-item:hover{border-color:var(--accent-cyan);box-shadow:0 0 10px rgba(0,255,242,.3);}
        .list-item-label{font-size:12px;color:var(--text-primary);}
        .list-item-value{font-size:12px;color:var(--accent-cyan);}
        .health-indicator{width:8px;height:8px;border-radius:50%;margin-left:10px;}
        .health-indicator.healthy{background:var(--accent-green);box-shadow:0 0 10px var(--accent-green);}
        .health-indicator.degraded{background:var(--accent-yellow);box-shadow:0 0 10px var(--accent-yellow);}
        .health-indicator.down{background:var(--accent-red);box-shadow:0 0 10px var(--accent-red);}
        button{background:transparent;border:1px solid var(--accent-cyan);color:var(--accent-cyan);padding:10px 20px;border-radius:4px;cursor:pointer;font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:1px;text-transform:uppercase;transition:all .3s ease;position:relative;overflow:hidden;}
        button::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(0,255,242,.3);border-radius:50%;transform:translate(-50%,-50%);transition:width .6s ease,height .6s ease;}
        button:hover::before{width:300px;height:300px;}
        button:hover{box-shadow:0 0 20px var(--accent-cyan);}
        button span{position:relative;z-index:1;}
        .toggle-container{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(0,255,242,.05);border:1px solid var(--grid-color);border-radius:4px;margin-bottom:10px;}
        .toggle-switch{position:relative;width:50px;height:24px;background:rgba(255,255,255,.1);border-radius:12px;cursor:pointer;transition:all .3s ease;}
        .toggle-switch.active{background:var(--accent-cyan);box-shadow:0 0 15px var(--accent-cyan);}
        .toggle-slider{position:absolute;top:2px;left:2px;width:20px;height:20px;background:white;border-radius:50%;transition:all .3s ease;box-shadow:0 2px 5px rgba(0,0,0,.3);}
        .toggle-switch.active .toggle-slider{left:28px;}
        input[type=text],input[type=number],select,textarea{width:100%;background:rgba(0,255,242,.05);border:1px solid var(--grid-color);color:var(--text-primary);padding:10px;border-radius:4px;font-family:'Share Tech Mono',monospace;font-size:12px;margin-bottom:10px;transition:all .3s ease;}
        input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent-cyan);box-shadow:0 0 15px rgba(0,255,242,.3);}
        .tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:1px solid var(--grid-color);}
        .tab{padding:12px 24px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text-secondary);cursor:pointer;transition:all .3s ease;}
        .tab:hover{color:var(--accent-cyan);}
        .tab.active{color:var(--accent-cyan);border-bottom-color:var(--accent-cyan);box-shadow:0 0 10px var(--accent-cyan);}
        .tab-content{display:none;}
        .tab-content.active{display:block;}
        .chart-container{height:150px;position:relative;margin-top:20px;}
        .chart-line{stroke:var(--accent-cyan);stroke-width:2;fill:none;filter:drop-shadow(0 0 5px var(--accent-cyan));}
        .chart-area{fill:url(#chartGradient);}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .panel{animation:fadeIn .5s ease;}
        @media(max-width:768px){.grid-layout{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr}}
        .alert{padding:15px;border-radius:4px;margin-bottom:20px;border:1px solid;animation:fadeIn .5s ease;}
        .alert.success{background:rgba(0,255,136,.1);border-color:var(--accent-green);color:var(--accent-green);}
        .alert.error{background:rgba(255,68,68,.1);border-color:var(--accent-red);color:var(--accent-red);}
        .alert.warning{background:rgba(255,235,59,.1);border-color:var(--accent-yellow);color:var(--accent-yellow);}
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <header>
        <div class="logo">
            <div class="logo-icon">DIAMOND</div>
            <div class="logo-text">
                <h1>VEIL</h1>
                <p>STEALTH DNS/DHCP SYSTEM</p>
            </div>
        </div>
        <div class="status-indicator">
            <div class="status-item"><div class="status-dot active" id="dns-status"></div><span>DNS</span></div>
            <div class="status-item"><div class="status-dot active" id="dhcp-status"></div><span>DHCP</span></div>
            <div class="status-item"><div class="status-dot active" id="privacy-status"></div><span>PRIVACY</span></div>
        </div>
    </header>

    <!-- Gauges -->
    <div class="grid-layout">
        <div class="panel">
            <div class="panel-header"><span class="panel-title">Query Rate</span><span class="panel-icon">LIGHTNING</span></div>
            <div class="gauge-container">
                <div class="gauge">
                    <svg width="200" height="200">
                        <defs><linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#00fff2"/><stop offset="100%" stop-color="#b388ff"/>
                        </linearGradient></defs>
                        <circle class="gauge-bg" cx="100" cy="100" r="85"/>
                        <circle class="gauge-fill" id="query-gauge" cx="100" cy="100" r="85" stroke="url(#g1)" stroke-dasharray="534" stroke-dashoffset="534"/>
                    </svg>
                    <div class="gauge-center"><div class="gauge-value" id="query-rate">0</div><div class="gauge-label">Q/s</div></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><span class="panel-title">Cache Hit Rate</span><span class="panel-icon">MEMORY</span></div>
            <div class="gauge-container">
                <div class="gauge">
                    <svg width="200" height="200">
                        <circle class="gauge-bg" cx="100" cy="100" r="85"/>
                        <circle class="gauge-fill" id="cache-gauge" cx="100" cy="100" r="85" stroke-dasharray="534" stroke-dashoffset="534"/>
                    </svg>
                    <div class="gauge-center"><div class="gauge-value" id="cache-hit-rate">0</div><div class="gauge-label">%</div></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><span class="panel-title">Privacy Ops</span><span class="panel-icon">LOCK</span></div>
            <div class="gauge-container">
                <div class="gauge">
                    <svg width="200" height="200">
                        <circle class="gauge-bg" cx="100" cy="100" r="85"/>
                        <circle class="gauge-fill" id="privacy-gauge" cx="100" cy="100" r="85" stroke-dasharray="534" stroke-dashoffset="534"/>
                    </svg>
                    <div class="gauge-center"><div class="gauge-value" id="privacy-ops">0</div><div class="gauge-label">OPS</div></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><span class="panel-title">Blocked Queries</span><span class="panel-icon">SHIELD</span></div>
            <div class="gauge-container">
                <div class="gauge">
                    <svg width="200" height="200">
                        <defs><linearGradient id="g2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#ff4444"/><stop offset="100%" stop-color="#ffeb3b"/>
                        </linearGradient></defs>
                        <circle class="gauge-bg" cx="100" cy="100" r="85"/>
                        <circle class="gauge-fill" id="blocked-gauge" cx="100" cy="100" r="85" stroke="url(#g2)" stroke-dasharray="534" stroke-dashoffset="534"/>
                    </svg>
                    <div class="gauge-center"><div class="gauge-value" id="blocked-value" style="color:#ff4444;text-shadow:0 0 20px #ff4444;">0</div><div class="gauge-label">BLOCKED</div></div>
                </div>
            </div>
        </div>

        <!-- NEW: DNS Response Time -->
        <div class="panel">
            <div class="panel-header"><span class="panel-title">Avg DNS Resp Time</span><span class="panel-icon">CLOCK</span></div>
            <div class="gauge-container">
                <div class="gauge">
                    <svg width="200" height="200">
                        <defs><linearGradient id="g3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#00ff88"/><stop offset="100%" stop-color="#00fff2"/>
                        </linearGradient></defs>
                        <circle class="gauge-bg" cx="100" cy="100" r="85"/>
                        <circle class="gauge-fill" id="latency-gauge" cx="100" cy="100" r="85" stroke="url(#g3)" stroke-dasharray="534" stroke-dashoffset="534"/>
                    </svg>
                    <div class="gauge-center"><div class="gauge-value" id="latency-value">0</div><div class="gauge-label">ms</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid-layout">
        <div class="panel">
            <div class="panel-header"><span class="panel-title">DNS Statistics</span><span class="panel-icon">CHART</span></div>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-label">Total Queries</div><div class="stat-value" id="total-queries">0</div></div>
                <div class="stat-item"><div class="stat-label">Blocked</div><div class="stat-value" id="blocked-queries">0</div></div>
                <div class="stat-item"><div class="stat-label">Cache Hits</div><div class="stat-value" id="cache-hits">0</div></div>
                <div class="stat-item"><div class="stat-label">Upstream</div><div class="stat-value" id="upstream-queries">0</div></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><span class="panel-title">Privacy Stats</span><span class="panel-icon">SHIELD</span></div>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-label">Padded</div><div class="stat-value" id="padded">0</div></div>
                <div class="stat-item"><div class="stat-label">ECS Stripped</div><div class="stat-value" id="ecs-stripped">0</div></div>
                <div class="stat-item"><div class="stat-label">0x20 Encoded</div><div class="stat-value" id="case-random">0</div></div>
                <div class="stat-item"><div class="stat-label">DNSSEC Valid</div><div class="stat-value" id="dnssec-valid">0</div></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><span class="panel-title">DHCP Statistics</span><span class="panel-icon">NETWORK</span></div>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-label">Active Leases</div><div class="stat-value" id="active-leases">0</div></div>
                <div class="stat-item"><div class="stat-label">Offers Sent</div><div class="stat-value" id="dhcp-offers">0</div></div>
                <div class="stat-item"><div class="stat-label">ACKs Sent</div><div class="stat-value" id="dhcp-acks">0</div></div>
                <div class="stat-item"><div class="stat-label">Pool Usage</div><div class="stat-value" id="pool-usage">0<span class="stat-unit">%</span></div></div>
            </div>
        </div>
    </div>

    <!-- Top 10 Clients & Blocked -->
    <div class="grid-layout">
        <div class="panel">
            <div class="panel-header"><span class="panel-title">Top 10 Clients</span><span class="panel-icon">USER</span></div>
            <div class="list-container" id="top-clients"></div>
        </div>

        <div class="panel">
            <div class="panel-header"><span class="panel-title">Top 10 Blocked</span><span class="panel-icon">BAN</span></div>
            <div class="list-container" id="top-blocked"></div>
        </div>
    </div>

    <!-- Upstream Servers -->
    <div class="panel">
        <div class="panel-header"><span class="panel-title">Upstream Servers</span><span class="panel-icon">LINK</span></div>
        <div class="list-container" id="upstream-list"></div>
    </div>

    <!-- Cache / Blocklist -->
    <div class="grid-layout">
        <div class="panel">
            <div class="panel-header"><span class="panel-title">Cache Status</span><span class="panel-icon">DISK</span></div>
            <div class="stat-item"><div class="stat-label">Cache Size</div><div class="stat-value" id="cache-size">0 / 10000</div>
                <div class="progress-bar"><div class="progress-fill" id="cache-bar" style="width:0%"></div></div>
            </div>
            <div class="stat-item" style="margin-top:15px;"><div class="stat-label">Blocklist Size</div><div class="stat-value" id="blocklist-size">0 domains</div></div>
            <div style="margin-top:15px;display:flex;gap:10px;">
                <button onclick="flushCache()"><span>Flush Cache</span></button>
                <button onclick="reloadBlocklist()"><span>Reload Blocklist</span></button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><span class="panel-title">Query Timeline</span><span class="panel-icon">GRAPH</span></div>
            <div class="chart-container">
                <svg id="query-chart" width="100%" height="150">
                    <defs><linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="#00fff2" stop-opacity=".5"/>
                        <stop offset="100%" stop-color="#00fff2" stop-opacity="0"/>
                    </linearGradient></defs>
                </svg>
            </div>
        </div>
    </div>

    <!-- Configuration Tabs (ALL SETTINGS) -->
    <div class="panel">
        <div class="panel-header"><span class="panel-title">Configuration</span><span class="panel-icon">GEAR</span></div>
        <div class="tabs">
            <button class="tab active" onclick="openTab(event,'dns')"><span>DNS</span></button>
            <button class="tab" onclick="openTab(event,'dhcp')"><span>DHCP</span></button>
            <button class="tab" onclick="openTab(event,'privacy')"><span>Privacy</span></button>
            <button class="tab" onclick="openTab(event,'blocking')"><span>Blocking</span></button>
            <button class="tab" onclick="openTab(event,'advanced')"><span>Advanced</span></button>
        </div>

        <!-- DNS -->
        <div id="dns" class="tab-content active">
            <div class="toggle-container"><span>DNS Enabled</span><div class="toggle-switch active" data-key="enabled" onclick="toggle(this)"></div></div>
            <label class="stat-label">Upstream DNS (one per line)</label>
            <textarea id="upstream-servers" rows="4"></textarea>
            <label class="stat-label">DNS Port</label><input type="number" id="dns-port" value="53"/>
            <label class="stat-label">Cache TTL (s)</label><input type="number" id="cache-ttl" value="3600"/>
            <label class="stat-label">Cache Max Size</label><input type="number" id="cache-max-size" value="10000"/>
            <div class="toggle-container"><span>Stale Serving</span><div class="toggle-switch active" data-key="stale_serving" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>Cache Prewarm</span><div class="toggle-switch active" data-key="cache_prewarm_enabled" onclick="toggle(this)"></div></div>
            <button style="margin-top:15px;" onclick="saveSection('dns')"><span>Save DNS</span></button>
        </div>

        <!-- DHCP -->
        <div id="dhcp" class="tab-content">
            <div class="toggle-container"><span>DHCP Enabled</span><div class="toggle-switch" data-key="dhcp_enabled" onclick="toggle(this)"></div></div>
            <label class="stat-label">Subnet (CIDR)</label><input type="text" id="dhcp-subnet" placeholder="192.168.1.0/24"/>
            <label class="stat-label">Gateway</label><input type="text" id="dhcp-gateway" placeholder="192.168.1.1"/>
            <label class="stat-label">DNS Servers (comma)</label><input type="text" id="dhcp-dns" placeholder="192.168.1.1"/>
            <label class="stat-label">Lease Time (s)</label><input type="number" id="dhcp-lease" value="86400"/>
            <label class="stat-label">Range Start</label><input type="text" id="dhcp-range-start" placeholder="192.168.1.100"/>
            <label class="stat-label">Range End</label><input type="text" id="dhcp-range-end" placeholder="192.168.1.200"/>
            <div class="toggle-container"><span>Ping Before Offer</span><div class="toggle-switch active" data-key="dhcp_ping_check" onclick="toggle(this)"></div></div>
            <button style="margin-top:15px;" onclick="saveSection('dhcp')"><span>Save DHCP</span></button>
        </div>

        <!-- Privacy -->
        <div id="privacy" class="tab-content">
            <div class="toggle-container"><span>Padding (RFC 7830)</span><div class="toggle-switch active" data-key="padding_enabled" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>0x20 Randomisation</span><div class="toggle-switch active" data-key="case_randomization" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>ECS Stripping</span><div class="toggle-switch active" data-key="ecs_strip" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>DNSSEC Validation</span><div class="toggle-switch active" data-key="dnssec_validate" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>Query Jitter</span><div class="toggle-switch active" data-key="query_jitter" onclick="toggle(this)"></div></div>
            <label class="stat-label">Jitter Range (ms)</label><input type="text" id="jitter-range" value="10-100"/>
            <div class="toggle-container"><span>DoH</span><div class="toggle-switch active" data-key="doh_enabled" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>DoT</span><div class="toggle-switch active" data-key="dot_enabled" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>DoQ</span><div class="toggle-switch active" data-key="doq_enabled" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>SafeSearch</span><div class="toggle-switch" data-key="safesearch_enabled" onclick="toggle(this)"></div></div>
            <button style="margin-top:15px;" onclick="saveSection('privacy')"><span>Save Privacy</span></button>
        </div>

        <!-- Blocking -->
        <div id="blocking" class="tab-content">
            <div class="toggle-container"><span>Blocking Enabled</span><div class="toggle-switch active" data-key="blocking_enabled" onclick="toggle(this)"></div></div>
            <label class="stat-label">Block Response</label>
            <select id="block-response">
                <option value="NXDOMAIN">NXDOMAIN</option>
                <option value="REFUSED">REFUSED</option>
                <option value="0.0.0.0">0.0.0.0</option>
                <option value="custom_ip">Custom IP</option>
            </select>
            <label class="stat-label">Custom Block IP</label><input type="text" id="block-custom-ip" value="0.0.0.0"/>
            <label class="stat-label">Blocklist URLs (one per line)</label>
            <textarea id="blocklist-urls" rows="6"></textarea>
            <div class="toggle-container"><span>Auto-Update</span><div class="toggle-switch active" data-key="blocklist_update_enabled" onclick="toggle(this)"></div></div>
            <label class="stat-label">Update Interval (s)</label><input type="number" id="blocklist-interval" value="86400"/>
            <button style="margin-top:15px;" onclick="saveSection('blocking')"><span>Save Blocking</span></button>
        </div>

        <!-- Advanced -->
        <div id="advanced" class="tab-content">
            <div class="toggle-container"><span>Zero Log</span><div class="toggle-switch" data-key="zero_log" onclick="toggle(this)"></div></div>
            <div class="toggle-container"><span>Rebinding Protection</span><div class="toggle-switch active" data-key="rebinding_protection" onclick="toggle(this)"></div></div>
            <label class="stat-label">Rebinding Whitelist (comma)</label><input type="text" id="rebinding-whitelist" placeholder="local,home"/>
            <label class="stat-label">Rate Limit QPS</label><input type="number" id="rate-qps" value="20"/>
            <label class="stat-label">Rate Limit Burst</label><input type="number" id="rate-burst" value="50"/>
            <button style="margin-top:15px;" onclick="saveSection('advanced')"><span>Save Advanced</span></button>
        </div>
    </div>

    <!-- Active Leases -->
    <div class="panel">
        <div class="panel-header"><span class="panel-title">Active DHCP Leases</span><span class="panel-icon">DEVICE</span></div>
        <div class="list-container" id="leases-list"></div>
    </div>
</div>

<script>
/* -------------------------------------------------
   GLOBAL STATE
------------------------------------------------- */
let cfg = {}, stats = {}, history = [], historyMax = 60;

/* -------------------------------------------------
   FETCH / UPDATE
------------------------------------------------- */
async function loadConfig(){const r=await fetch('/api/veil/config');cfg=await r.json();populateUI();}
async function fetchStats(){const r=await fetch('/api/veil/stats');stats=await r.json();render();}
async function postConfig(p){await fetch('/api/veil/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});}
function showAlert(m,t='success'){
    const el=document.createElement('div');el.className=`alert ${t}`;el.textContent=m;
    document.querySelector('.container').insertBefore(el,document.querySelector('.container').firstChild);
    setTimeout(()=>el.remove(),5000);
}

/* -------------------------------------------------
   RENDER
------------------------------------------------- */
function render(){
    // Gauges
    gauge('query-gauge', stats.queries_per_second||0, 200);
    $('#query-rate').textContent=Math.round(stats.queries_per_second||0);
    const cacheRate=stats.total_queries? (stats.cache_hits/stats.total_queries*100):0;
    gauge('cache-gauge', cacheRate, 100);
    $('#cache-hit-rate').textContent=Math.round(cacheRate);
    const privOps=(stats.dns_padded||0)+(stats.dns_ecs_stripped||0)+(stats.dns_0x20||0);
    gauge('privacy-gauge', privOps, stats.total_queries||1);
    $('#privacy-ops').textContent=privOps;
    const blockedPct=stats.total_queries? (stats.dns_blocked/stats.total_queries*100):0;
    gauge('blocked-gauge', blockedPct, 100);
    $('#blocked-value').textContent=(stats.dns_blocked||0).toLocaleString();

    // NEW: DNS response time
    const avgLat = stats.dns_upstream ? Math.round(stats.dns_upstream_latency || 0) : 0;
    gauge('latency-gauge', avgLat, 500);
    $('#latency-value').textContent=avgLat;

    // Stats
    $('#total-queries').textContent=(stats.dns_queries||0).toLocaleString();
    $('#blocked-queries').textContent=(stats.dns_blocked||0).toLocaleString();
    $('#cache-hits').textContent=(stats.dns_cached||0).toLocaleString();
    $('#upstream-queries').textContent=(stats.dns_upstream||0).toLocaleString();
    $('#padded').textContent=(stats.dns_padded||0).toLocaleString();
    $('#ecs-stripped').textContent=(stats.dns_ecs_stripped||0).toLocaleString();
    $('#case-random').textContent=(stats.dns_0x20||0).toLocaleString();
    $('#dnssec-valid').textContent=(stats.dns_dnssec_validated||0).toLocaleString();
    $('#active-leases').textContent=stats.active_leases||0;
    $('#dhcp-offers').textContent=stats.dhcp_offers||0;
    $('#dhcp-acks').textContent=stats.dhcp_acks||0;
    const poolPct=stats.pool_total? (stats.active_leases/stats.pool_total*100):0;
    $('#pool-usage').textContent=Math.round(poolPct);

    // Cache / Blocklist
    const cacheMax=cfg.cache_max_size||10000;
    $('#cache-size').innerHTML=`${stats.cache_size||0} / ${cacheMax}`;
    $('#cache-bar').style.width=(stats.cache_size/cacheMax*100)+'%';
    $('#blocklist-size').innerHTML=`${(stats.blocklist_size||0).toLocaleString()} <span class="stat-unit">domains</span>`;

    // Top 10 Clients
    const tc=document.getElementById('top-clients'); tc.innerHTML='';
    (stats.top_clients||[]).slice(0,10).forEach(c=>{
        tc.innerHTML+=`<div class="list-item"><span class="list-item-label">${c.ip}</span><span class="list-item-value">${c.count}</span></div>`;
    });

    // Top 10 Blocked
    const tb=document.getElementById('top-blocked'); tb.innerHTML='';
    (stats.top_blocked||[]).slice(0,10).forEach(b=>{
        tb.innerHTML+=`<div class="list-item"><span class="list-item-label">${b.domain}</span><span class="list-item-value">${b.count}</span></div>`;
    });

    // Upstream health
    const ul=document.getElementById('upstream-list'); ul.innerHTML='';
    for(const[srv,data]of Object.entries(stats.upstream_health||{})){
        const health=data.healthy? (data.success_rate>=0.8?'healthy':'degraded'):'down';
        ul.innerHTML+=`<div class="list-item"><span class="list-item-label">${srv}</span>
            <div style="display:flex;align-items:center;gap:10px;">
                <span class="list-item-value">${Math.round(data.success_rate*100)}%</span>
                <div class="health-indicator ${health}"></div>
            </div></div>`;
    }

    // Leases
    const ll=document.getElementById('leases-list'); ll.innerHTML='';
    if(!(stats.leases||[]).length) ll.innerHTML='<div class="list-item"><span class="list-item-label">No active leases</span></div>';
    else (stats.leases||[]).forEach(l=>{
        ll.innerHTML+=`<div class="list-item"><div><div class="list-item-label">${l.hostname||'Unknown'}</div>
            <div class="list-item-value" style="font-size:10px;">${l.mac}</div></div>
            <div class="list-item-value">${l.ip}</div></div>`;
    });

    // Status dots
    setDot('dns-status',stats.dns_running);
    setDot('dhcp-status',stats.dhcp_running);
    setDot('privacy-status',cfg.padding_enabled||cfg.ecs_strip||cfg.dnssec_validate);

    // History for chart
    history.push({t:Date.now(),v:stats.queries_per_second||0});
    if(history.length>historyMax) history.shift();
    drawChart();
}
function gauge(id,val,max){
    const circ=534, pct=Math.min(val/max*100,100), offset=circ-circ*pct/100;
    document.getElementById(id).style.strokeDashoffset=offset;
}
function setDot(id,on){document.getElementById(id).className='status-dot '+(on?'active':'inactive');}
function $(s){return document.getElementById(s);}
function drawChart(){
    if(history.length<2) return;
    const svg=$('query-chart'), w=svg.clientWidth, h=150, pad=20;
    const maxV=Math.max(...history.map(p=>p.v),10);
    const step=(w-pad*2)/(historyMax-1);
    let line='', area='';
    history.forEach((p,i)=>{
        const x=pad+i*step, y=h-pad-((p.v/maxV)*(h-pad*2));
        if(i===0){line=`M${x},${y}`;area=`M${x},${h-pad} L${x},${y}`;}
        else{line+=` L${x},${y}`;area+=` L${x},${y}`;}
    });
    area+=` L${w-pad},${h-pad} Z`;
    svg.innerHTML=`<defs><linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="#00fff2" stop-opacity=".5"/>
        <stop offset="100%" stop-color="#00fff2" stop-opacity="0"/>
    </linearGradient></defs><path class="chart-area" d="${area}"/><path class="chart-line" d="${line}"/>`;
}

/* -------------------------------------------------
   UI POPULATION
------------------------------------------------- */
function populateUI(){
    $('#upstream-servers').value=(cfg.upstream_servers||[]).join('\n');
    $('#dns-port').value=cfg.dns_port||53;
    $('#cache-ttl').value=cfg.cache_ttl||3600;
    $('#cache-max-size').value=cfg.cache_max_size||10000;
    setToggle('stale_serving',cfg.stale_serving);
    setToggle('cache_prewarm_enabled',cfg.cache_prewarm_enabled);
    setToggle('dhcp_enabled',cfg.dhcp_enabled);
    $('#dhcp-subnet').value=cfg.dhcp_subnet||'192.168.1.0/24';
    $('#dhcp-gateway').value=cfg.dhcp_gateway||'192.168.1.1';
    $('#dhcp-dns').value=(cfg.dhcp_dns_servers||[]).join(', ');
    $('#dhcp-lease').value=cfg.dhcp_lease_time||86400;
    $('#dhcp-range-start').value=cfg.dhcp_range_start||'192.168.1.100';
    $('#dhcp-range-end').value=cfg.dhcp_range_end||'192.168.1.200';
    setToggle('dhcp_ping_check',cfg.dhcp_ping_check);
    setToggle('padding_enabled',cfg.padding_enabled);
    setToggle('case_randomization',cfg.case_randomization);
    setToggle('ecs_strip',cfg.ecs_strip);
    setToggle('dnssec_validate',cfg.dnssec_validate);
    setToggle('query_jitter',cfg.query_jitter);
    $('#jitter-range').value=`${cfg.query_jitter_ms?.[0]??10}-${cfg.query_jitter_ms?.[1]??100}`;
    setToggle('doh_enabled',cfg.doh_enabled);
    setToggle('dot_enabled',cfg.dot_enabled);
    setToggle('doq_enabled',cfg.doq_enabled);
    setToggle('safesearch_enabled',cfg.safesearch_enabled);
    setToggle('blocking_enabled',cfg.blocking_enabled);
    $('#block-response').value=cfg.block_response_type||'NXDOMAIN';
    $('#block-custom-ip').value=cfg.block_custom_ip||'0.0.0.0';
    $('#blocklist-urls').value=(cfg.blocklist_urls||[]).join('\n');
    setToggle('blocklist_update_enabled',cfg.blocklist_update_enabled);
    $('#blocklist-interval').value=cfg.blocklist_update_interval||86400;
    setToggle('zero_log',cfg.zero_log);
    setToggle('rebinding_protection',cfg.rebinding_protection);
    $('#rebinding-whitelist').value=(cfg.rebinding_whitelist||[]).join(', ');
    $('#rate-qps').value=cfg.rate_limit_qps||20;
    $('#rate-burst').value=cfg.rate_limit_burst||50;
}
function setToggle(key,val){
    const el=document.querySelector(`.toggle-switch[data-key="${key}"]`);
    if(el) el.classList.toggle('active',!!val);
}

/* -------------------------------------------------
   TABS & TOGGLES
------------------------------------------------- */
function openTab(e,id){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    e.target.classList.add('active');
    $('#'+id).classList.add('active');
}
function toggle(el){el.classList.toggle('active');}

/* -------------------------------------------------
   SAVE SECTION
------------------------------------------------- */
async function saveSection(section){
    const p={...cfg};
    if(section==='dns'){
        p.upstream_servers=$('#upstream-servers').value.split('\n').map(s=>s.trim()).filter(Boolean);
        p.dns_port=+($('#dns-port').value);
        p.cache_ttl=+($('#cache-ttl').value);
        p.cache_max_size=+($('#cache-max-size').value);
        p.stale_serving=getToggle('stale_serving');
        p.cache_prewarm_enabled=getToggle('cache_prewarm_enabled');
    }
    if(section==='dhcp'){
        p.dhcp_enabled=getToggle('dhcp_enabled');
        p.dhcp_subnet=$('#dhcp-subnet').value;
        p.dhcp_gateway=$('#dhcp-gateway').value;
        p.dhcp_dns_servers=$('#dhcp-dns').value.split(',').map(s=>s.trim()).filter(Boolean);
        p.dhcp_lease_time=+($('#dhcp-lease').value);
        p.dhcp_range_start=$('#dhcp-range-start').value;
        p.dhcp_range_end=$('#dhcp-range-end').value;
        p.dhcp_ping_check=getToggle('dhcp_ping_check');
    }
    if(section==='privacy'){
        p.padding_enabled=getToggle('padding_enabled');
        p.case_randomization=getToggle('case_randomization');
        p.ecs_strip=getToggle('ecs_strip');
        p.dnssec_validate=getToggle('dnssec_validate');
        p.query_jitter=getToggle('query_jitter');
        const [min,max]=$('#jitter-range').value.split('-').map(Number);
        p.query_jitter_ms=[min,max];
        p.doh_enabled=getToggle('doh_enabled');
        p.dot_enabled=getToggle('dot_enabled');
        p.doq_enabled=getToggle('doq_enabled');
        p.safesearch_enabled=getToggle('safesearch_enabled');
    }
    if(section==='blocking'){
        p.blocking_enabled=getToggle('blocking_enabled');
        p.block_response_type=$('#block-response').value;
        p.block_custom_ip=$('#block-custom-ip').value;
        p.blocklist_urls=$('#blocklist-urls').value.split('\n').map(s=>s.trim()).filter(Boolean);
        p.blocklist_update_enabled=getToggle('blocklist_update_enabled');
        p.blocklist_update_interval=+($('#blocklist-interval').value);
    }
    if(section==='advanced'){
        p.zero_log=getToggle('zero_log');
        p.rebinding_protection=getToggle('rebinding_protection');
        p.rebinding_whitelist=$('#rebinding-whitelist').value.split(',').map(s=>s.trim()).filter(Boolean);
        p.rate_limit_qps=+($('#rate-qps').value);
        p.rate_limit_burst=+($('#rate-burst').value);
    }
    try{
        await postConfig(p);
        cfg=p;
        showAlert('Saved','success');
    }catch(e){showAlert('Save error','error');}
}
function getToggle(key){
    return document.querySelector(`.toggle-switch[data-key="${key}"]`).classList.contains('active');
}

/* -------------------------------------------------
   BUTTON ACTIONS
------------------------------------------------- */
async function flushCache(){await fetch('/api/veil/cache',{method:'DELETE'});showAlert('Cache flushed','success');}
async function reloadBlocklist(){await fetch('/api/veil/blocklist/reload',{method:'POST'});showAlert('Blocklist reloaded','success');}
async function updateBlocklists(){showAlert('Updatingâ€¦','warning');await fetch('/api/veil/blocklist/update',{method:'POST'});showAlert('Blocklists updated','success');}

/* -------------------------------------------------
   STARTUP
------------------------------------------------- */
document.addEventListener('DOMContentLoaded',()=>{
    loadConfig();
    fetchStats();
    setInterval(fetchStats,2000);
    setInterval(drawChart,1000);
});
</script>
</body>
</html>